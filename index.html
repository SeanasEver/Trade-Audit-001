<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>贸易业务交易对手关联关系分析模型</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#0F3FA8',
            success: '#36D399',
            warning: '#FBBD23',
            danger: '#F87272',
            neutral: {
              100: '#F8FAFC',
              200: '#F1F5F9',
              300: '#E2E8F0',
              400: '#CBD5E1',
              500: '#94A3B8',
              600: '#64748B',
              700: '#334155',
              800: '#1E293B',
              900: '#0F172A',
            }
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
  .content-auto { content-visibility: auto; }
  .scrollbar-thin { scrollbar-width: thin; }
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .transition-height { transition: max-height 0.3s ease-in-out; }

  /* ===== 表头：最浅蓝色背景 + 深蓝文字 + 居中 + 自动列宽 ===== */
  #results-table thead tr { background-color: #EFF6FF; }  /* blue-50 */
  #results-table thead th {
    color: #1E40AF;         /* blue-800，深色易读 */
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    padding: 0.75rem 0.5rem;
    width: auto;             /* 让浏览器按内容决定宽度 */
    min-width: max-content;
	border-right: 1px solid #ffffff;   /* 白线分隔 */
  }

  /* ===== 数据行 ===== */
  #results-table tbody td {
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    padding: 0.75rem 0.5rem;
  }
  /* 前 4 列：文字多长列就多宽 */
  #results-table tbody td:nth-child(-n+4) {
    white-space: nowrap;
    width: auto;
    min-width: max-content;
  }
  /* 第 5 列：可换行 + 左对齐 */
  #results-table tbody td:nth-child(5) {
    white-space: normal;
    text-align: left;
    word-break: break-word;
    max-width: 40rem;
  }
}
	/* 页面淡入淡出效果 */
body {
  transition: opacity 0.35s ease;
  overflow: hidden; /* 初始状态禁用滚动 */
}

/* 主页按钮点击效果 */
#btn-home:active {
  transform: scale(0.95);
}

/* 内容区域平滑过渡 */
.transition-all {
  transition-property: all;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 300ms;
}
/* ===== 结果表格列宽控制与Tooltip ===== */
.truncated-col {
  max-width: 6em !important;
  /* overflow: hidden !important; */  /* 注释掉或删除此行 */
  white-space: nowrap !important;
  text-overflow: ellipsis !important;
  position: relative;
  cursor: pointer;
}

.description-col {
  max-width: 13em !important;
  /* overflow: hidden !important; */  /* 注释掉或删除此行 */
  white-space: nowrap !important;
  text-overflow: ellipsis !important;
  position: relative;
  cursor: pointer;
}

/* 汇总视图专用列宽 */
.serial-number-col {
  max-width: 8em !important; /* 4个汉字 ≈ 8em */
  /* overflow: hidden !important; */   /* 注释掉，避免tooltip被遮挡 */
  white-space: nowrap !important;
  text-overflow: ellipsis !important;
}

.project-id-col {
  max-width: 30em !important; /* 30个英文字符 */
  /* overflow: hidden !important; */   /* 注释掉，避免tooltip被遮挡 */
  white-space: nowrap !important;
  text-overflow: ellipsis !important;
}

.project-name-col {
  max-width: 25em !important; /* 25个字符 */
  /* overflow: hidden !important; */   /* 注释掉，避免tooltip被遮挡 */
  white-space: nowrap !important;
  text-overflow: ellipsis !important;
}

.clue-count-col {
  max-width: 12em !important; /* 6个汉字 ≈ 12em */
  /* overflow: hidden !important; */   /* 注释掉，避免tooltip被遮挡 */
  white-space: nowrap !important;
  text-overflow: ellipsis !important;
}


.tooltip {
  position: relative;
}

/* 卡片激活状态：蓝色边框 */
.stat-card.active {
  border: 2px solid #165DFF; /* primary color */
  box-shadow: 0 0 0 4px rgba(22, 93, 255, 0.1);
}

/* 卡片隐藏状态 */
.stat-card.hidden {
  display: none !important;
}

/* 卡片悬停效果 */
.stat-card {
  cursor: pointer;
  transition: all 0.3s ease;
}
.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* 统计卡片样式 - 确保与标题高度一致 */
.stat-card {
  height: 2.5rem; /* 与标题高度一致 */
  display: flex;
  align-items: center;
  padding: 0 1rem;
  border-radius: 0.5rem;
  background: white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

/* 统计卡片悬停效果 */
.stat-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

/* 统计卡片中的数字加粗 */
.stat-card .font-bold {
  font-weight: 700;
}

/* 响应式调整 - 在小屏幕上改为垂直布局 */
@media (max-width: 768px) {
  #results-section > div:first-child {
    flex-direction: column;
    gap: 1rem;
  }
  
  .stat-card {
    justify-content: center;
  }
}

/* 默认在单元格下方显示悬浮框 */
.tooltip:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  background: rgba(0, 0, 0, 0.95);
  color: white;
  padding: 8px 12px;
  border-radius: 4px;
  font-size: 12px;
  line-height: 1.5;
  white-space: pre-wrap;
  word-break: break-word;
  z-index: 99999;
  max-width: 500px;
  /* 移除高度限制，确保内容完全显示 */
  /* max-height: 300px; */
  overflow-y: visible;        /* 改为可见，禁用滚动条 */
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
  pointer-events: none;
  text-align: left;
  top: 100%;
  left: 0;
  transform: translateY(5px);
  display: block !important;
  visibility: visible !important;
}

/* 表格最后三行在上方显示，避免被底部遮挡 */
tbody tr:nth-last-child(-n+3) td.tooltip:hover::after {
  bottom: 100%;
  top: auto;
  transform: translateY(-5px);
  /* 同步移除高度限制（可选，因已继承基础样式） */
  max-height: none;
  overflow-y: visible;
}

/* 公告牌模态框样式 */
#changelog-modal .changelog-board-container {
  max-width: 400px; /* 固定宽度 */
  width: 100%;
  background: white; /* 确保容器背景为白色 */
  border-radius: 12px; /* 保持圆角一致 */
}

#changelog-modal .changelog-board {
  background: white;
  border: 2px solid #165DFF;
  border-radius: 12px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  padding: 2rem;
  min-height: auto;
  max-height: none;
  overflow-y: visible;
  position: relative;
  transition: all 0.3s ease;
  width: 100%;
  max-width: 600px;
}


/* 标题样式 */
#changelog-modal .changelog-title {
  color: #165DFF;
  font-family: 'Inter', sans-serif;
  padding-bottom: 1rem;
  border-bottom: 1px solid #E2E8F0;
  font-weight: 600;
  font-size: 1.25rem;
}

/* 内容样式 */
#changelog-modal .changelog-content {
  color: #334155;
  white-space: pre-line;
  padding: 1.5rem 0;
  font-size: 0.95rem;
  line-height: 1.6;
}

/* 日志条目样式 */
#changelog-modal .log-entry {
  margin-bottom: 0.75rem;
  padding-left: 1.25rem;
  text-indent: -1.25rem;
}

#changelog-modal .log-entry::before {
  content: '•';
  margin-right: 0.75rem;
  color: #165DFF;
  font-weight: bold;
}

/* 分页指示器 */
#changelog-modal .pagination-indicator {
  font-family: 'Inter', sans-serif;
  color: #64748B;
  font-size: 0.85rem;
  margin-top: 1.5rem;
}

/* 翻页箭头按钮 */
#changelog-modal .pagination-arrow {
  background: #F1F5F9;
  border: 1px solid #CBD5E1;
  border-radius: 6px;
  transition: all 0.2s ease;
}

#changelog-modal .pagination-arrow:hover {
  background: #165DFF;
  border-color: #165DFF;
  color: white;
}

#changelog-modal .pagination-arrow:hover i {
  color: white;
}

/* 模态框显示/隐藏动画 */
#changelog-modal {
  transition: opacity 0.3s ease;
}

#changelog-modal.hidden {
  opacity: 0;
  pointer-events: none;
}

#changelog-modal:not(.hidden) {
  opacity: 1;
}

/* 公告牌弹出动画 */
#changelog-modal .changelog-board {
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

#changelog-modal:not(.hidden) .changelog-board {
  transform: scale(1);
}

/* 圆形返回按钮样式 */
#back-to-summary-btn {
  min-width: 2rem; /* 确保按钮尺寸固定 */
  transition: all 0.3s ease;
}

#back-to-summary-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* 可点击卡片样式 */
.stat-card {
  cursor: pointer;
  transition: all 0.3s ease;
}
.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.stat-card.active {
  border: 2px solid #165DFF;
  box-shadow: 0 0 0 4px rgba(22, 93, 255, 0.1);
}

/* 一键导入示例数据按钮样式 */
#import-sample-btn {
  position: relative;
  overflow: hidden;
}

#import-sample-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.5s;
}

#import-sample-btn:hover::before {
  left: 100%;
}


  </style>
</head>

<body class="font-inter bg-neutral-100 text-neutral-800 min-h-screen flex flex-col">
  <!-- 网页锁屏层 -->
  <div id="lock-screen" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-[100] flex items-center justify-center">
    <div id="lock-icon" class="cursor-pointer text-white hover:text-primary transition-colors">
      <i class="fa fa-lock text-6xl"></i>
    </div>
  </div>

  <!-- 密码输入模态框 -->
  <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[101] hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <div class="text-center mb-6">
        <i class="fa fa-lock text-4xl text-primary mb-3"></i>
        <h3 class="text-xl font-semibold text-neutral-800">请输入密码</h3>
        <p class="text-sm text-neutral-600 mt-1">此网页需要密码才能访问</p>
      </div>
      <div class="space-y-4">
        <input 
          type="password" 
          id="password-input" 
          placeholder="请输入密码" 
          class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 text-neutral-800"
          autocomplete="off"
        >
        <div id="password-error" class="text-danger text-sm text-center hidden">
          请联系管理员获取密码！
        </div>
        <div class="flex gap-3">
          <button id="unlock-btn" class="flex-1 bg-primary hover:bg-secondary text-white py-2.5 px-4 rounded-lg transition-colors font-medium">
            解锁
          </button>
          <button id="cancel-btn" class="flex-1 bg-neutral-200 hover:bg-neutral-300 text-neutral-700 py-2.5 px-4 rounded-lg transition-colors font-medium">
            取消
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-md sticky top-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <i class="fa fa-bar-chart text-primary text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold text-neutral-800">贸易业务交易对手关联关系分析模型</h1>
      </div>
      <div class="flex items-center space-x-4">
  <!-- 新增：更新日志按钮 -->
  <button id="changelog-btn" class="hidden md:flex items-center text-neutral-600 hover:text-primary transition-colors relative">
  <i class="fa fa-calendar-check-o mr-1"></i>
  <span>公告</span>
</button>
  <!-- 修改开始：右上角帮助按钮，hover 显示提示 -->
  <button class="hidden md:flex items-center text-neutral-600 hover:text-primary transition-colors relative group">
    <i class="fa fa-question-circle mr-1"></i>
    <span>帮助</span>
    <!-- 悬停提示 -->
    <span class="absolute top-full mt-2 left-1/2 -translate-x-1/2
                 whitespace-nowrap px-3 py-2 text-sm text-white bg-neutral-800
                 rounded shadow-lg opacity-0 group-hover:opacity-100
                 transition-opacity duration-300 pointer-events-none">
      模型为离线分析，网页本身不存储和上传数据，请放心使用！<br>
      如有疑问，可随时联系 wangxch57 ☺️ 
    </span>
  </button>
  <!-- 修改结束 -->
  <!-- 回到首页图标 -->
  <button id="btn-home" class="hidden md:flex items-center justify-center w-10 h-10 rounded-full text-neutral-600 hover:text-primary hover:bg-primary/10 transition-all duration-300 transform hover:scale-110" aria-label="回到首页">
    <i class="fa fa-home text-xl"></i>
  </button>
  <button class="md:hidden text-neutral-600 hover:text-primary">
    <i class="fa fa-bars text-xl"></i>
  </button>
</div>
    </div>
  </header>

  <!-- 主要内容区 -->
  <main class="flex-grow container mx-auto px-4 py-6">
    <!-- 页面介绍 -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8 transform hover:shadow-md transition-shadow">
      <h2 class="text-xl font-semibold mb-3 text-neutral-800">模型介绍</h2>
      <p class="text-neutral-600 mb-4">
        本模型用于识别疑似与存在特定利益关系的交易对手开展的贸易行为，通过导入相关数据表格， 系统将自动进行交叉分析，检测不同交易对手之间的人员、联系方式和地址等信息交叉情况， 帮助发现潜在的虚假贸易线索。
      </p>
      <div class="flex items-center text-sm text-primary">
        <i class="fa fa-info-circle mr-2"></i>
        <span>请按照要求依次导入所需数据表格，模型将进行自动分析并给出线索</span>
      </div>
    </div>

    <!-- 数据导入区域 -->
<section class="mb-10">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-semibold text-neutral-800 flex items-center">
      <i class="fa fa-upload text-primary mr-2"></i>数据导入
    </h2>
    <button id="import-sample-btn" class="bg-gradient-to-r from-green-500 to-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all transform hover:scale-105 hover:shadow-lg flex items-center">
  <i class="fa fa-magic mr-2"></i>一键导入示例数据
</button>
  </div>
      
      <!-- 导入表格1：投标供应商清单 -->
      <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden">
        <div class="p-4 border-b border-neutral-200 flex justify-between items-center cursor-pointer import-header" data-target="table1-content">
          <div class="flex items-center">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-primary text-white rounded-full text-sm mr-2">1</span>
            <h3 class="font-medium">采办项目投标供应商清单</h3>
          </div>
          <i class="fa fa-chevron-down text-neutral-500 transition-transform duration-300"></i>
        </div>
        
        <div id="table1-content" class="p-4 max-h-[700px] overflow-y-auto transition-height">
          <div class="mb-4">
            <p class="text-sm text-neutral-600 mb-2">
              <i class="fa fa-info-circle text-primary mr-1"></i>
              数据字段：采办-标段编号、交易类型（采购/销售）、投标供应商
            </p>
            <p class="text-sm text-neutral-500 italic">
              提示：该数据表可从线下获取或使用<a href="https://smartaudit.cnooc/#/login" target="_blank" class="text-primary underline hover:text-secondary">数智化审计平台</a>下载
            </p>
			<button class="text-sm text-primary hover:underline" onclick="downloadTemplate(1)">
				<i class="fa fa-download mr-1"></i>下载模板
			</button>
          </div>
		  
          <div class="border-2 border-dashed border-neutral-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer file-drop-area" data-table="1">
            <i class="fa fa-file-excel-o text-4xl text-neutral-400 mb-3"></i>
            <p class="mb-2 text-neutral-600">拖放Excel文件到此处，或</p>
            <button class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors">
              选择文件
            </button>
            <input type="file" class="hidden" accept=".xlsx,.xls,.csv">
          </div>
          
          <div class="mt-4 hidden file-preview">
            <div class="flex items-center justify-between p-3 bg-neutral-100 rounded-lg">
              <div class="flex items-center">
                <i class="fa fa-file-excel-o text-success mr-2"></i>
                <span class="text-sm font-medium filename">投标供应商清单.xlsx</span>
              </div>
              <button class="text-neutral-500 hover:text-danger transition-colors">
                <i class="fa fa-times"></i>
              </button>
            </div>
            
            <!-- 数据预览区域 -->
            <div class="mt-4 border border-neutral-200 rounded-lg overflow-hidden">
              <div class="bg-neutral-50 p-3 border-b border-neutral-200 flex justify-between items-center">
                <h4 class="font-medium text-sm text-neutral-700">数据预览 (前5行)</h4>
                <span class="text-xs text-neutral-500 total-records">共 0 条记录</span>
              </div>
              <div class="overflow-x-auto data-preview-container max-h-60"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 导入表格2：供应商基本信息表 -->
      <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden">
        <div class="p-4 border-b border-neutral-200 flex justify-between items-center cursor-pointer import-header" data-target="table2-content">
          <div class="flex items-center">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-primary text-white rounded-full text-sm mr-2">2</span>
            <h3 class="font-medium">供应商基本信息表</h3>
          </div>
          <i class="fa fa-chevron-down text-neutral-500 transition-transform duration-300"></i>
        </div>
        
        <div id="table2-content" class="p-4 max-h-[700px] overflow-y-auto transition-height hidden">
          <div class="mb-4">
            <p class="text-sm text-neutral-600 mb-2">
              <i class="fa fa-info-circle text-primary mr-1"></i>
              数据字段：原文件导入名称，系统匹配企业名称，登记状态统一社会信用代码，法定代表人等42个字段
            </p>
            <p class="text-sm text-neutral-500 italic">
              提示：该数据表可从<a href="https://www.tianyancha.com/" target="_blank" class="text-primary underline hover:text-secondary">天眼查官网</a>下载（下载后直接导入即可，模型将从第二行开始读取数据）
            </p>
			<button class="text-sm text-primary hover:underline" onclick="downloadTemplate(2)">
				<i class="fa fa-download mr-1"></i>下载模板
			</button>			
          </div>
          
          <div class="border-2 border-dashed border-neutral-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer file-drop-area" data-table="2">
            <i class="fa fa-file-excel-o text-4xl text-neutral-400 mb-3"></i>
            <p class="mb-2 text-neutral-600">拖放Excel文件到此处，或</p>
            <button class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors">
              选择文件
            </button>
            <input type="file" class="hidden" accept=".xlsx,.xls,.csv">
          </div>
          
          <div class="mt-4 hidden file-preview">
            <div class="flex items-center justify-between p-3 bg-neutral-100 rounded-lg">
              <div class="flex items-center">
                <i class="fa fa-file-excel-o text-success mr-2"></i>
                <span class="text-sm font-medium filename">供应商基本信息表.xlsx</span>
              </div>
              <button class="text-neutral-500 hover:text-danger transition-colors">
                <i class="fa fa-times"></i>
              </button>
            </div>
            
            <!-- 数据预览区域 -->
            <div class="mt-4 border border-neutral-200 rounded-lg overflow-hidden">
              <div class="bg-neutral-50 p-3 border-b border-neutral-200 flex justify-between items-center">
                <h4 class="font-medium text-sm text-neutral-700">数据预览 (前5行)</h4>
                <span class="text-xs text-neutral-500 total-records">共 0 条记录</span>
              </div>
              <div class="overflow-x-auto data-preview-container max-h-60"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 导入表格3：实控人信息表 -->
      <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden">
        <div class="p-4 border-b border-neutral-200 flex justify-between items-center cursor-pointer import-header" data-target="table3-content">
          <div class="flex items-center">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-primary text-white rounded-full text-sm mr-2">3</span>
            <h3 class="font-medium">实控人信息表</h3>
          </div>
          <i class="fa fa-chevron-down text-neutral-500 transition-transform duration-300"></i>
        </div>
        
        <div id="table3-content" class="p-4 max-h-[700px] overflow-y-auto transition-height hidden">
          <div class="mb-4">
            <p class="text-sm text-neutral-600 mb-2">
              <i class="fa fa-info-circle text-primary mr-1"></i>
              数据字段：企业名称、实控人、股份、开始时间、结束时间
            </p>
            <p class="text-sm text-neutral-500 italic">
              提示：该数据表可从<a href="https://smartaudit.cnooc/#/login" target="_blank" class="text-primary underline hover:text-secondary">数智化审计平台</a>下载
            </p>
			<button class="text-sm text-primary hover:underline" onclick="downloadTemplate(3)">
				<i class="fa fa-download mr-1"></i>下载模板
			</button>			
          </div>
          
          <div class="border-2 border-dashed border-neutral-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer file-drop-area" data-table="3">
            <i class="fa fa-file-excel-o text-4xl text-neutral-400 mb-3"></i>
            <p class="mb-2 text-neutral-600">拖放Excel文件到此处，或</p>
            <button class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors">
              选择文件
            </button>
            <input type="file" class="hidden" accept=".xlsx,.xls,.csv">
          </div>
          
          <div class="mt-4 hidden file-preview">
            <div class="flex items-center justify-between p-3 bg-neutral-100 rounded-lg">
              <div class="flex items-center">
                <i class="fa fa-file-excel-o text-success mr-2"></i>
                <span class="text-sm font-medium filename">实控人信息表.xlsx</span>
              </div>
              <button class="text-neutral-500 hover:text-danger transition-colors">
                <i class="fa fa-times"></i>
              </button>
            </div>
            
            <!-- 数据预览区域 -->
            <div class="mt-4 border border-neutral-200 rounded-lg overflow-hidden">
              <div class="bg-neutral-50 p-3 border-b border-neutral-200 flex justify-between items-center">
                <h4 class="font-medium text-sm text-neutral-700">数据预览 (前5行)</h4>
                <span class="text-xs text-neutral-500 total-records">共 0 条记录</span>
              </div>
              <div class="overflow-x-auto data-preview-container max-h-60"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 导入表格4：股东信息表 -->
      <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden">
        <div class="p-4 border-b border-neutral-200 flex justify-between items-center cursor-pointer import-header" data-target="table4-content">
          <div class="flex items-center">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-primary text-white rounded-full text-sm mr-2">4</span>
            <h3 class="font-medium">股东信息表</h3>
          </div>
          <i class="fa fa-chevron-down text-neutral-500 transition-transform duration-300"></i>
        </div>
        
        <div id="table4-content" class="p-4 max-h-[700px] overflow-y-auto transition-height hidden">
          <div class="mb-4">
            <p class="text-sm text-neutral-600 mb-2">
              <i class="fa fa-info-circle text-primary mr-1"></i>
              数据字段：企业名称、股东名、股份、开始时间、结束时间
            </p>
            <p class="text-sm text-neutral-500 italic">
              提示：该数据表可从<a href="https://smartaudit.cnooc/#/login" target="_blank" class="text-primary underline hover:text-secondary">数智化审计平台</a>下载
            </p>
			<button class="text-sm text-primary hover:underline" onclick="downloadTemplate(4)">
				<i class="fa fa-download mr-1"></i>下载模板
			</button>			
          </div>
          
          <div class="border-2 border-dashed border-neutral-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer file-drop-area" data-table="4">
            <i class="fa fa-file-excel-o text-4xl text-neutral-400 mb-3"></i>
            <p class="mb-2 text-neutral-600">拖放Excel文件到此处，或</p>
            <button class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors">
              选择文件
            </button>
            <input type="file" class="hidden" accept=".xlsx,.xls,.csv">
          </div>
          
          <div class="mt-4 hidden file-preview">
            <div class="flex items-center justify-between p-3 bg-neutral-100 rounded-lg">
              <div class="flex items-center">
                <i class="fa fa-file-excel-o text-success mr-2"></i>
                <span class="text-sm font-medium filename">股东信息表.xlsx</span>
              </div>
              <button class="text-neutral-500 hover:text-danger transition-colors">
                <i class="fa fa-times"></i>
              </button>
            </div>
            
            <!-- 数据预览区域 -->
            <div class="mt-4 border border-neutral-200 rounded-lg overflow-hidden">
              <div class="bg-neutral-50 p-3 border-b border-neutral-200 flex justify-between items-center">
                <h4 class="font-medium text-sm text-neutral-700">数据预览 (前5行)</h4>
                <span class="text-xs text-neutral-500 total-records">共 0 条记录</span>
              </div>
              <div class="overflow-x-auto data-preview-container max-h-60"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 导入表格5：高管信息表 -->
      <div class="bg-white rounded-xl shadow-sm mb-8 overflow-hidden">
        <div class="p-4 border-b border-neutral-200 flex justify-between items-center cursor-pointer import-header" data-target="table5-content">
          <div class="flex items-center">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-primary text-white rounded-full text-sm mr-2">5</span>
            <h3 class="font-medium">高管信息表</h3>
          </div>
          <i class="fa fa-chevron-down text-neutral-500 transition-transform duration-300"></i>
        </div>
        
        <div id="table5-content" class="p-4 max-h-[700px] overflow-y-auto transition-height hidden">
          <div class="mb-4">
            <p class="text-sm text-neutral-600 mb-2">
              <i class="fa fa-info-circle text-primary mr-1"></i>
              数据字段：企业名称、高管名、高管职务、开始时间、结束时间
            </p>
            <p class="text-sm text-neutral-500 italic">
              提示：该数据表可从<a href="https://smartaudit.cnooc/#/login" target="_blank" class="text-primary underline hover:text-secondary">数智化审计平台</a>下载
            </p>
			<button class="text-sm text-primary hover:underline" onclick="downloadTemplate(5)">
				<i class="fa fa-download mr-1"></i>下载模板
			</button>			
          </div>
          
          <div class="border-2 border-dashed border-neutral-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer file-drop-area" data-table="5">
            <i class="fa fa-file-excel-o text-4xl text-neutral-400 mb-3"></i>
            <p class="mb-2 text-neutral-600">拖放Excel文件到此处，或</p>
            <button class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors">
              选择文件
            </button>
            <input type="file" class="hidden" accept=".xlsx,.xls,.csv">
          </div>
          
          <div class="mt-4 hidden file-preview">
            <div class="flex items-center justify-between p-3 bg-neutral-100 rounded-lg">
              <div class="flex items-center">
                <i class="fa fa-file-excel-o text-success mr-2"></i>
                <span class="text-sm font-medium filename">高管信息表.xlsx</span>
              </div>
              <button class="text-neutral-500 hover:text-danger transition-colors">
                <i class="fa fa-times"></i>
              </button>
            </div>
            
            <!-- 数据预览区域 -->
            <div class="mt-4 border border-neutral-200 rounded-lg overflow-hidden">
              <div class="bg-neutral-50 p-3 border-b border-neutral-200 flex justify-between items-center">
                <h4 class="font-medium text-sm text-neutral-700">数据预览 (前5行)</h4>
                <span class="text-xs text-neutral-500 total-records">共 0 条记录</span>
              </div>
              <div class="overflow-x-auto data-preview-container max-h-60"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 分析按钮 -->
      <div class="text-center mb-8">
        <button id="analyze-btn" class="bg-primary hover:bg-secondary text-white px-8 py-3 rounded-lg text-lg font-medium transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100" disabled>
          <i class="fa fa-line-chart mr-2"></i>开始分析
        </button>
      </div>
    </section>
    
    <!-- 分析结果区域 -->
        <section id="results-section" class="hidden">
      <!-- 结果头部区域：标题 + 统计卡片 + 操作按钮 -->
      <div class="flex items-center justify-between mb-6">
        <!-- 左侧：分析结果标题 -->
        <h2 class="text-xl font-semibold text-neutral-800 flex items-center">
          <i class="fa fa-search text-primary mr-2"></i>分析结果
        </h2>

        <!-- 中间：统计卡片 -->
        <div class="flex items-center gap-4">
          <!-- 线索个数卡片 -->
          <div class="bg-white rounded-lg shadow-sm px-4 py-2 flex items-center stat-card" id="clue-count-card">
            <span class="text-sm text-neutral-600 mr-2">线索个数：</span>
            <span class="text-lg font-bold text-neutral-800" id="total-clues">0</span>
          </div>

          <!-- 涉及项目个数卡片 -->
<div class="bg-white rounded-lg shadow-sm px-4 py-2 flex items-center stat-card" id="total-projects-card">
  <span class="text-sm text-neutral-600 mr-2">涉及项目个数：</span>
  <span class="text-lg font-bold text-neutral-800" id="total-projects">0</span>
</div>
<!-- 返回按钮（圆形图标，仅在明细视图显示） -->
<button id="back-to-summary-btn" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 text-white flex items-center justify-center transition-colors hidden" onclick="backToSummary()" title="返回项目汇总">
  <i class="fa fa-arrow-left text-sm"></i>
</button>
        </div>

        <!-- 右侧：操作按钮 -->
        <div class="flex items-center gap-3">
          <button id="reimport-btn" class="bg-neutral-500 hover:bg-neutral-600 text-white px-3 py-1.5 text-sm rounded-lg transition-colors flex items-center">
            <i class="fa fa-refresh mr-2 text-sm"></i>重新导入数据
          </button>
          <button id="export-results" class="bg-primary hover:bg-secondary text-white px-3 py-1.5 text-sm rounded-lg transition-colors flex items-center">
            <i class="fa fa-download mr-2 text-sm"></i>导出结果
          </button>
        </div>
      </div>
      
      <!-- 原结果概览区域（已移除内容） -->
      <div class="mb-6 hidden"></div>
      
     <!-- 筛选功能已移除，改为卡片点击交互 -->
<div id="filter-section" class="hidden"></div>
     
      
      <!-- 结果表格 -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full" id="results-table">
            <thead class="bg-neutral-100 sticky top-0 z-10">
  <tr>
    <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b truncated-col">采办-标段编号</th>
    <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b">类型</th>
    <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b truncated-col">相同信息</th>
    <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b description-col">情况描述</th>
	<th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b">备注</th>
  </tr>
</thead>
            <tbody id="results-body">
              <!-- 结果将通过JS动态填充 -->
              <tr>
                <td colspan="5" class="py-8 text-center text-neutral-500">暂无分析结果，请先导入数据并进行分析</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- 分页 -->
                <!-- 分页 -->
        <div class="p-4 border-t border-neutral-200 flex justify-between items-center" id="pagination" style="display: none;">
          <div class="flex items-center gap-4">
            <div class="text-sm text-neutral-600">
              显示 <span id="showing-start">0</span> 至 <span id="showing-end">0</span>，共 <span id="total-count">0</span> 条记录
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-neutral-600">每页显示：</label>
              <select id="page-size" class="bg-neutral-100 border border-neutral-300 rounded-lg py-1 px-2 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm">
  <option value="5" selected>5条</option>
  <option value="10">10条</option>
  <option value="20">20条</option>
  <option value="50">50条</option>
  <option value="100">100条</option>
  <option value="1000">1000条</option>
</select>
            </div>
          </div>
          <div class="flex space-x-1">
            <button id="prev-page" class="w-8 h-8 flex items-center justify-center rounded border border-neutral-300 text-neutral-600 hover:bg-neutral-100 disabled:opacity-50" disabled>
              <i class="fa fa-chevron-left text-xs"></i>
            </button>
            <button id="next-page" class="w-8 h-8 flex items-center justify-center rounded border border-neutral-300 text-neutral-600 hover:bg-neutral-100 disabled:opacity-50" disabled>
              <i class="fa fa-chevron-right text-xs"></i>
            </button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- 分析中加载动画 -->
    <section id="loading-section" class="hidden">
      <div class="bg-white rounded-xl shadow-sm p-8 text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
        <h3 class="text-lg font-medium text-neutral-800 mb-2">正在进行数据分析</h3>
        <p class="text-neutral-600" id="analysis-status">准备分析数据...</p>
        <div class="mt-6 w-full bg-neutral-200 rounded-full h-2">
          <div class="bg-primary h-2 rounded-full" id="progress-bar" style="width: 0%"></div>
        </div>
      </div>
    </section>
  </main>

<!-- 更新日志公告牌模态框 -->
<div id="changelog-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="changelog-board-container mx-4">
    <!-- 公告牌主体 -->
    <div id="changelog-board" class="changelog-board relative">
      <!-- 关闭按钮 -->
      <button id="changelog-close" class="absolute top-3 right-3 text-neutral-400 hover:text-neutral-600 transition-colors">
        <i class="fa fa-times text-lg"></i>
      </button>
      
      <!-- 标题 -->
      <h3 class="changelog-title text-lg font-semibold text-center mb-4">公告</h3>
      
      <!-- 内容区域 -->
      <div id="changelog-content" class="changelog-content text-sm leading-relaxed">
        <!-- 内容将通过 JavaScript 动态填充 -->
      </div>
      
      <!-- 分页指示器 -->
      <div class="pagination-indicator text-center text-xs text-neutral-500 mt-4">
        <span id="current-page">1</span> / <span id="total-pages">1</span>
      </div>
      
      <!-- 翻页按钮容器 -->
      <div class="pagination-arrows absolute bottom-4 right-4 flex gap-2">
        <!-- 上一页 -->
        <button id="prev-page-btn" class="pagination-arrow w-8 h-8 flex items-center justify-center text-neutral-400 hover:text-primary transition-colors disabled:opacity-30" disabled>
          <i class="fa fa-caret-left text-lg"></i>
        </button>
        <!-- 下一页 -->
        <button id="next-page-btn" class="pagination-arrow w-8 h-8 flex items-center justify-center text-neutral-400 hover:text-primary transition-colors disabled:opacity-30">
          <i class="fa fa-caret-right text-lg"></i>
        </button>
      </div>
    </div>
  </div>
</div>


  <!-- 页脚 -->
  <footer class="bg-white border-t border-neutral-200 py-6 mt-10">
    <div class="container mx-auto px-4 text-center text-neutral-600 text-sm">
      <p>© 2026 贸易业务交易对手关联关系分析模型</p>
      <p class="mt-1">Power by wangxch57</p>
    </div>
  </footer>

  <!-- 通知提示 -->
  <div id="notification" class="fixed bottom-6 right-6 bg-white shadow-lg rounded-lg p-4 transform translate-y-20 opacity-0 transition-all duration-300 max-w-md z-50 hidden">
    <div class="flex items-start">
      <i id="notification-icon" class="fa fa-check-circle text-success text-xl mt-0.5 mr-3"></i>
      <div>
        <h4 id="notification-title" class="font-medium text-neutral-800">操作成功</h4>
        <p id="notification-message" class="text-sm text-neutral-600 mt-1">文件已成功上传</p>
      </div>
      <button id="close-notification" class="ml-auto text-neutral-400 hover:text-neutral-600">
        <i class="fa fa-times"></i>
      </button>
    </div>
  </div>

  <script>
	// 文本截断辅助函数
function truncateText(text, maxLength) {
  if (!text) return '';
  const str = String(text);
  return str.length > maxLength ? str.substring(0, maxLength) + '…' : str;
}
	
	// 下载模板功能
function downloadTemplate(tableNum) {
  let headers = [];
  let filename = '';

  switch(tableNum) {
    case 1:
      headers = ['采办-标段编号', '交易类型（采购/销售）', '投标供应商'];
      filename = '投标供应商清单模板.xlsx';
      break;
    case 2:
      headers = [
        '原文件导入名称', '系统匹配企业名称', '登记状态', '统一社会信用代码', '法定代表人',
        '成立日期', '核准日期', '注册资本', '实缴资本', '电话', '更多电话', '所属省份',
        '所属城市', '所属区县', '企业地址', '通信地址', '邮箱', '更多邮箱', '登记机关',
        '企业(机构)类型', '纳税人资质', '纳税人识别号', '注册号', '组织机构代码',
        '营业期限', '国标行业门类', '国标行业大类', '国标行业中类', '国标行业小类',
        '曾用名', '英文名', '企业规模', '经营范围', '企业简介', '官网', '最新年报年份',
        '最新年报营业收入', '参保人数', '参保人数所属年报', '天眼评分', '科创分', '科创等级'
      ];
      filename = '供应商基本信息表模板.xlsx';
      break;
    case 3:
      headers = ['企业名称', '实控人', '股份', '开始时间', '结束时间'];
      filename = '实控人信息表模板.xlsx';
      break;
    case 4:
      headers = ['企业名称', '股东名', '股份', '开始时间', '结束时间'];
      filename = '股东信息表模板.xlsx';
      break;
    case 5:
      headers = ['企业名称', '高管名', '高管职务', '开始时间', '结束时间'];
      filename = '高管信息表模板.xlsx';
      break;
    default:
      showNotification('error', '未知模板', '无法识别的模板类型');
      return;
  }

  // 创建 Excel 文件
  const ws = XLSX.utils.aoa_to_sheet([headers]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '模板');

  // 下载文件
  XLSX.writeFile(wb, filename);
  showNotification('success', '模板下载成功', `已下载：${filename}`);
}
        // 存储导入的数据
    const importedData = {
      table1: null, // 投标供应商清单
      table2: null, // 供应商基本信息表
      table3: null, // 实控人信息表
      table4: null, // 股东信息表
      table5: null  // 高管信息表
    };
    
    // 分析结果数据
    let analysisResults = [];

// 新增：视图状态管理（false=正常视图, true=汇总视图）
let isSummaryView = true;

    // 分页状态变量
    let currentPage = 1;
    let pageSize = 5;// 默认5条
    let filteredResults = [];

        // 网页锁功能
    function initLockScreen() {
      const lockScreen = document.getElementById('lock-screen');
      const lockIcon = document.getElementById('lock-icon');
      const passwordModal = document.getElementById('password-modal');
      const passwordInput = document.getElementById('password-input');
      const unlockBtn = document.getElementById('unlock-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      const passwordError = document.getElementById('password-error');
      
      const CORRECT_PASSWORD = 'lhsj';
      
      // 点击锁图标显示密码输入框
      lockIcon.addEventListener('click', function() {
        passwordModal.classList.remove('hidden');
        passwordModal.classList.add('flex');
        passwordInput.focus();
      });
      
        // 解锁函数
  function unlock() {
    const inputPassword = passwordInput.value.trim();
    
    if (inputPassword === CORRECT_PASSWORD) {
      // 密码正确，隐藏锁屏层和模态框
      lockScreen.classList.add('hidden');
      passwordModal.classList.add('hidden');
      passwordModal.classList.remove('flex');
      // 清空输入
      passwordInput.value = '';
      passwordError.classList.add('hidden');
      // 解锁后恢复滚动
      document.body.style.overflow = 'auto';
    } else {
      // 密码错误，显示提示
      passwordError.classList.remove('hidden');
      passwordInput.value = '';
      passwordInput.focus();
    }
  }
      
      // 点击解锁按钮
      unlockBtn.addEventListener('click', unlock);
      
      // 回车键解锁
      passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          unlock();
        }
      });
      
      // 点击取消按钮
      cancelBtn.addEventListener('click', function() {
        passwordModal.classList.add('hidden');
        passwordModal.classList.remove('flex');
        passwordInput.value = '';
        passwordError.classList.add('hidden');
      });
      
      // 点击模态框背景关闭
      passwordModal.addEventListener('click', function(e) {
        if (e.target === passwordModal) {
          passwordModal.classList.add('hidden');
          passwordModal.classList.remove('flex');
          passwordInput.value = '';
          passwordError.classList.add('hidden');
        }
      });
    }
    
    // 监听页面加载完成
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化网页锁
      initLockScreen();
      
      // 导入区域展开/折叠功能
      const importHeaders = document.querySelectorAll('.import-header');
      importHeaders.forEach(header => {
        header.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const targetContent = document.getElementById(targetId);
          const icon = this.querySelector('i');
          
          if (targetContent.classList.contains('hidden')) {
            targetContent.classList.remove('hidden');
            icon.classList.add('rotate-180');
          } else {
            targetContent.classList.add('hidden');
            icon.classList.remove('rotate-180');
          }
        });
      });
      
      // 默认展开第一个表格的导入区域
      document.querySelector('.import-header').click();
      
      // 文件上传功能
      const fileDropAreas = document.querySelectorAll('.file-drop-area');
      const fileInputs = document.querySelectorAll('.file-drop-area input[type="file"]');
      const fileButtons = document.querySelectorAll('.file-drop-area button');
      const removeButtons = document.querySelectorAll('.file-preview button');
      const analyzeBtn = document.getElementById('analyze-btn');
      
      // 点击按钮触发文件选择
      fileButtons.forEach((button, index) => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          fileInputs[index].click();
        });
      });
      
      // 文件选择后处理
      fileInputs.forEach((input, index) => {
        input.addEventListener('change', function(e) {
          handleFileUpload(e, index + 1); // 表格编号从1开始
        });
      });
      
      // 拖放功能
      fileDropAreas.forEach((area, index) => {
        area.addEventListener('dragover', function(e) {
          e.preventDefault();
          this.classList.add('border-primary');
        });
        
        area.addEventListener('dragleave', function() {
          this.classList.remove('border-primary');
        });
        
        area.addEventListener('drop', function(e) {
          e.preventDefault();
          this.classList.remove('border-primary');
          handleFileUpload(e, index + 1); // 表格编号从1开始
        });
      });
      
      // 移除已上传文件
      removeButtons.forEach((button, index) => {
        button.addEventListener('click', function() {
          const tableNum = index + 1;
          const preview = this.closest('.file-preview');
          const dropArea = preview.previousElementSibling;
          const fileName = preview.querySelector('.filename').textContent;
          
          // 清除存储的数据
          importedData[`table${tableNum}`] = null;
          
          preview.classList.add('hidden');
          dropArea.classList.remove('hidden');
          
          showNotification('info', '文件已移除', `已移除文件：${fileName}`);
          
          // 检查是否所有文件都已上传
          checkAllFilesUploaded();
        });
      });
      
      // 分析按钮点击事件
      analyzeBtn.addEventListener('click', async function() {
  collapseIntro();
  document.querySelector('section').classList.add('hidden');
  document.getElementById('loading-section').classList.remove('hidden');
  document.getElementById('results-section').classList.add('hidden');
  
  // 等待异步分析完成
  await performAnalysis();
});
      
            // 筛选功能已改为卡片式交互，无需下拉框事件监听
// 相关事件在renderStatCards()函数中绑定
      
      // 导出结果
      document.getElementById('export-results').addEventListener('click', exportResults);
      
      // 关闭通知
      document.getElementById('close-notification').addEventListener('click', hideNotification);
      
      // 分页控件事件监听
      document.getElementById('prev-page').addEventListener('click', () => changePage('prev'));
      document.getElementById('next-page').addEventListener('click', () => changePage('next'));
      document.getElementById('page-size').addEventListener('change', handlePageSizeChange);
      
      // 滚动时导航栏效果
      window.addEventListener('scroll', function() {
        const header = document.querySelector('header');
        if (window.scrollY > 10) {
          header.classList.add('py-2');
          header.classList.remove('py-3');
        } else {
          header.classList.add('py-3');
          header.classList.remove('py-2');
        }
      });
    });
    
    // 处理文件上传
function handleFileUpload(e, tableNum) {
  const file = e.dataTransfer ? e.dataTransfer.files[0] : e.target.files[0];
  if (!file) return;
  
  // 验证文件类型
  const fileExt = file.name.split('.').pop().toLowerCase();
  if (!['xlsx', 'xls', 'csv'].includes(fileExt)) {
    showNotification('error', '文件格式错误', '请上传Excel或CSV格式的文件');
    return;
  }
  
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      // 解析Excel文件
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheetName = workbook.SheetNames[0];
      /* 1. 先把日期数字转成 Date 对象 */
      const worksheet = workbook.Sheets[firstSheetName];
      if (!worksheet['!ref']) {                       // 保险：防止空表
        throw new Error('工作表为空');
      }
      const range = XLSX.utils.decode_range(worksheet['!ref']);
      for (let R = range.s.r; R <= range.e.r; R++) {
        for (let C = range.s.c; C <= range.e.c; C++) {
          const cell = worksheet[XLSX.utils.encode_cell({ r: R, c: C })];
          if (cell && cell.t === 'n' && cell.v && cell.v > 40000) { // 粗略判断可能是日期
            cell.t = 'd';             // 标记成日期
            cell.v = new Date((cell.v - 25569) * 86400 * 1000); // 1900 基准转 Date
          }
        }
      }

      /* 2. 再转 JSON */
      let jsonData;
      let originalJsonData;
            
      if (tableNum === 2) {
        // 先获取完整数据用于预览
        originalJsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        // 获取工作表范围
        const range = XLSX.utils.decode_range(worksheet['!ref']);
        // 从第二行开始（索引从1开始）
        range.s.r = 1;
        worksheet['!ref'] = XLSX.utils.encode_range(range);
        jsonData = XLSX.utils.sheet_to_json(worksheet);
      } else {
        // 对于其他表格，直接获取数据
        originalJsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        jsonData = XLSX.utils.sheet_to_json(worksheet);
      }
      
      // 验证数据是否为空
      if (jsonData.length === 0) {
        showNotification('warning', '数据为空', `文件 ${file.name} 中未发现有效数据`);
        return;
      }

      // ✅ 【核心修改】初始化无效数据计数器（包含重复和无效数据）
      let invalidCount = 0;

      // ✅ 【核心修改】对table1进行去重和无效数据清理
      if (tableNum === 1) {
        const uniqueJsonData = [];
        const uniqueOriginalData = [originalJsonData[0]]; // 保留表头
        const seen = new Set();
        const dataRows = originalJsonData.slice(1); // 获取数据行
        
        for (let i = 0; i < jsonData.length; i++) {
          const record = jsonData[i];
          
          // ✅ 【核心修改】检查是否为无效数据：采办-标段编号为空
          if (!record['采办-标段编号'] ) {
            invalidCount++;
            continue; // 跳过无效数据
          }
          
          const key = `${record['采办-标段编号']}-${record['交易类型（采购/销售）']}-${record['投标供应商']}`;
          
          if (!seen.has(key)) {
            seen.add(key);
            uniqueJsonData.push(record);
            uniqueOriginalData.push(dataRows[i]); // 保留对应的原始行
          } else {
            invalidCount++; // 重复数据也计入无效数据
          }
        }
        
        // 使用清理后的数据
        jsonData = uniqueJsonData;
        originalJsonData = uniqueOriginalData;
      }
      // 对table2进行去重处理（根据"原文件导入名称"列）
      else if (tableNum === 2) {
        const uniqueJsonData = [];
        const uniqueOriginalData = [originalJsonData[0]]; // 保留表头
        const seen = new Set();
        const dataRows = originalJsonData.slice(1); // 获取数据行
        
        for (let i = 0; i < jsonData.length; i++) {
          const record = jsonData[i];
          const key = record['原文件导入名称']; // 仅根据供应商名称去重
          
          if (key && !seen.has(key)) {
            seen.add(key);
            uniqueJsonData.push(record);
            uniqueOriginalData.push(dataRows[i]); // 保留对应的原始行
          } else if (key) {
            invalidCount++; // ✅ 【核心修改】统一计数器
          }
        }
        
        // 使用去重后的数据
        jsonData = uniqueJsonData;
        originalJsonData = uniqueOriginalData;
      }
      // 对table3进行去重处理（根据"企业名称"和"实控人"组合）
      else if (tableNum === 3) {
        const uniqueJsonData = [];
        const uniqueOriginalData = [originalJsonData[0]]; // 保留表头
        const seen = new Set();
        const dataRows = originalJsonData.slice(1); // 获取数据行
        
        for (let i = 0; i < jsonData.length; i++) {
          const record = jsonData[i];
          const key = `${record['企业名称']}-${record['实控人']}`; // 根据企业和实控人组合去重
          
          if (key && key !== '-' && !seen.has(key)) {
            seen.add(key);
            uniqueJsonData.push(record);
            uniqueOriginalData.push(dataRows[i]); // 保留对应的原始行
          } else if (key && key !== '-') {
            invalidCount++; // ✅ 【核心修改】统一计数器
          }
        }
        
        // 使用去重后的数据
        jsonData = uniqueJsonData;
        originalJsonData = uniqueOriginalData;
      }
      // 对table4进行去重处理（根据"企业名称"和"股东名"组合）
      else if (tableNum === 4) {
        const uniqueJsonData = [];
        const uniqueOriginalData = [originalJsonData[0]]; // 保留表头
        const seen = new Set();
        const dataRows = originalJsonData.slice(1); // 获取数据行
        
        for (let i = 0; i < jsonData.length; i++) {
          const record = jsonData[i];
          const key = `${record['企业名称']}-${record['股东名']}`; // 根据企业和股东名组合去重
          
          if (key && key !== '-' && !seen.has(key)) {
            seen.add(key);
            uniqueJsonData.push(record);
            uniqueOriginalData.push(dataRows[i]); // 保留对应的原始行
          } else if (key && key !== '-') {
            invalidCount++; // ✅ 【核心修改】统一计数器
          }
        }
        
        // 使用去重后的数据
        jsonData = uniqueJsonData;
        originalJsonData = uniqueOriginalData;
      }
      // 对table5进行去重处理（根据"企业名称"和"高管名"组合）
      else if (tableNum === 5) {
        const uniqueJsonData = [];
        const uniqueOriginalData = [originalJsonData[0]]; // 保留表头
        const seen = new Set();
        const dataRows = originalJsonData.slice(1); // 获取数据行
        
        for (let i = 0; i < jsonData.length; i++) {
          const record = jsonData[i];
          const key = `${record['企业名称']}-${record['高管名']}`; // 根据企业和高管名组合去重
          
          if (key && key !== '-' && !seen.has(key)) {
            seen.add(key);
            uniqueJsonData.push(record);
            uniqueOriginalData.push(dataRows[i]); // 保留对应的原始行
          } else if (key && key !== '-') {
            invalidCount++; // ✅ 【核心修改】统一计数器
          }
        }
        
        // 使用去重后的数据
        jsonData = uniqueJsonData;
        originalJsonData = uniqueOriginalData;
      }

      // 存储解析后的数据
      importedData[`table${tableNum}`] = jsonData;
            
      // 更新UI
      const dropArea = document.querySelector(`.file-drop-area[data-table="${tableNum}"]`);
      const preview = dropArea.nextElementSibling;
      const fileNameElement = preview.querySelector('.filename');
      const totalRecordsElement = preview.querySelector('.total-records');
      const previewContainer = preview.querySelector('.data-preview-container');
            
      fileNameElement.textContent = file.name;
      
      // ✅ 【核心修改】更新记录数显示，包含清理信息
      if (invalidCount > 0) {
        totalRecordsElement.textContent = `存在 ${invalidCount} 行重复数据或无效数据，已进行清理，最终导入 ${jsonData.length} 条记录`;
      } else {
        totalRecordsElement.textContent = `共 ${jsonData.length} 条记录`;
      }
            
      // 生成数据预览表格
      generateDataPreview(originalJsonData, previewContainer, tableNum);
            
      preview.classList.remove('hidden');
      dropArea.classList.add('hidden');
            
      showNotification('success', '文件上传成功', 
        `已成功上传：${file.name}，共 ${jsonData.length} 条记录`);
            
      // 检查是否所有文件都已上传
      checkAllFilesUploaded();
    } catch (error) {
      console.error('文件解析错误:', error);
      showNotification('error', '文件解析失败', '无法解析该文件，请检查文件格式是否正确');
    }
  };
      
  reader.onerror = function() {
    showNotification('error', '文件读取失败', '无法读取该文件，请重试');
  };
      
  if (fileExt === 'csv') {
    reader.readAsText(file);
  } else {
    reader.readAsArrayBuffer(file);
  }
}
    
    // 数据结构验证函数
    function validateDataStructure(data, tableNum) {
      // 检查数据是否为空
      if (!data || data.length === 0) {
        return { valid: false, message: '数据为空，未发现任何记录' };
      }
      
      // 检查第一条记录是否包含必要字段
      const firstRecord = data[0];
      if (!firstRecord || typeof firstRecord !== 'object') {
        return { valid: false, message: '数据格式错误，无法识别记录结构' };
      }
      
      // 根据不同表格类型验证必要字段
      let requiredFields = [];
      let tableName = '';
      
      switch(tableNum) {
        case 1:
          tableName = '采办项目投标供应商清单';
          requiredFields = ['采办-标段编号', '交易类型（采购/销售）', '投标供应商'];
          break;
        case 2:
          tableName = '供应商基本信息表';
          requiredFields = ['原文件导入名称', '法定代表人', '电话', '邮箱', '企业地址'];
          break;
        case 3:
          tableName = '实控人信息表';
          requiredFields = ['企业名称', '实控人'];
          break;
        case 4:
          tableName = '股东信息表';
          requiredFields = ['企业名称', '股东名'];
          break;
        case 5:
          tableName = '高管信息表';
          requiredFields = ['企业名称', '高管名', '高管职务'];
          break;
        default:
          return { valid: false, message: '未知的表格类型' };
      }
      
      // 检查必要字段是否存在
      const missingFields = requiredFields.filter(field => !firstRecord.hasOwnProperty(field));
      
      if (missingFields.length > 0) {
        return { 
          valid: false, 
          message: `${tableName} 缺少必要字段：${missingFields.join('、')}，请检查数据结构是否正确` 
        };
      }
      
      // 对特定表格进行额外验证
      if (tableNum === 1) {
  // 不再检查重复记录，重复数据将在上传时自动去重
  // 仅验证数据不为空即可
}
      
      if (tableNum === 2) {
  // 不再检查重复记录，重复数据将在上传时自动去重
  // 仅验证数据不为空即可
}
      
      return { valid: true, message: '数据结构验证通过' };
    }
    
    // 生成数据预览表格
    function generateDataPreview(originalData, container, tableNum) {
      // originalData 是包含表头的原始数据（数组形式）
      if (!originalData || originalData.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-neutral-500">无数据可预览</div>';
        return;
      }
      
      // 提取表头和数据行
      let headers, rows;

if (tableNum === 2) {
  // ✅ 修改：第二行作为表头，第一行跳过
  if (originalData.length < 2) {
    container.innerHTML = '<div class="p-4 text-center text-neutral-500">数据不足，无法预览</div>';
    return;
  }
  headers = originalData[1]; // ✅ 第二行作为表头
  rows = originalData.slice(2); // ✅ 从第三行开始是数据
} else {
  headers = originalData[0]; // 第一行是表头
  rows = originalData.slice(1); // 其余是数据
}
      
      // 限制预览的列数（最多显示6列）
      const maxColumns = 6;
      const displayHeaders = headers.slice(0, maxColumns);
      if (headers.length > maxColumns) {
        displayHeaders.push(`...(${headers.length - maxColumns}列)`);
      }
      
      // 限制预览的行数（最多显示5行）
      const previewRows = rows.slice(0, 5);   // 最多 5 行
      
      // 创建预览表格
      let tableHtml = '<table class="min-w-full divide-y divide-neutral-200 text-xs">';
      
      // 表头
      tableHtml += '<thead><tr class="bg-neutral-50">';
      displayHeaders.forEach(header => {
        tableHtml += `<th class="px-3 py-2 text-left font-medium text-neutral-700 whitespace-nowrap">${header || '未命名列'}</th>`;
      });
      tableHtml += '</tr></thead>';
      
      // 表体
      tableHtml += '<tbody class="bg-white divide-y divide-neutral-200">';
      
      if (previewRows.length === 0) {
  tableHtml += `<tr><td colspan="${displayHeaders.length}" class="px-3 py-4 text-center text-neutral-500">无数据</td></tr>`;
} else {
  previewRows.forEach(row => {
          tableHtml += '<tr class="hover:bg-neutral-50">';
          // 只显示前maxColumns列
          for (let i = 0; i < maxColumns; i++) {
            const cellValue = row[i] !== undefined ? row[i] : '';
            let displayValue;
if (cellValue instanceof Date && !isNaN(cellValue)) {
  displayValue = cellValue.toISOString().slice(0,10);   // yyyy-mm-dd
} else {
  displayValue = String(cellValue);
}
if (displayValue.length > 50) displayValue = displayValue.slice(0,50)+'…';
            tableHtml += `<td class="px-3 py-1 text-neutral-800 whitespace-nowrap">${displayValue}</td>`;
          }
          // 如果有更多列，显示省略标记
          if (row.length > maxColumns) {
            tableHtml += `<td class="px-3 py-2 text-neutral-500">...</td>`;
          }
          tableHtml += '</tr>';
        });
      }
      
      tableHtml += '</tbody></table>';
      
      container.innerHTML = tableHtml;
    }
    
    // 检查是否所有文件都已上传
    function checkAllFilesUploaded() {
      const allUploaded = Object.values(importedData).every(data => data !== null && data.length > 0);
      const analyzeBtn = document.getElementById('analyze-btn');
      
      if (allUploaded) {
        analyzeBtn.removeAttribute('disabled');
      } else {
        analyzeBtn.setAttribute('disabled', 'true');
      }
    }
    
    async function performAnalysis() {
  analysisResults = [];
  const progressBar = document.getElementById('progress-bar');
  const statusText = document.getElementById('analysis-status');
  
  // 真正的进度更新函数
  const updateProgress = (percent, status) => {
    progressBar.style.width = `${percent}%`;
    statusText.textContent = status;
  };
  
  try {
    updateProgress(5, '正在准备数据结构...');
    await new Promise(resolve => setTimeout(resolve, 100)); // 让UI更新
    
    // 验证数据
    if (!importedData.table1 || importedData.table1.length === 0) {
      throw new Error('投标供应商清单数据为空');
    }
    
    // 按项目分组（轻量操作，可同步）
    const projects = {};
    importedData.table1.forEach(item => {
      const projectKey = item['采办-标段编号'];
      if (!projects[projectKey]) {
        projects[projectKey] = {
          id: item['采办-标段编号'],
          name: '',   // 不再使用，保持空串
          suppliers: new Set()
        };
      }
      projects[projectKey].suppliers.add(item['投标供应商']);
    });
    
    const projectList = Object.values(projects).map(p => ({
      ...p,
      suppliers: Array.from(p.suppliers)
    }));
    
    if (projectList.length === 0) {
      throw new Error('未找到有效的项目数据');
    }
    
    // 分片异步分析人员/单位交叉
    updateProgress(15, '正在分析人员/单位交叉（0%）...');
    await analyzePersonCrossAsync(projectList, (progress) => {
      updateProgress(15 + progress * 0.3, `正在分析人员/单位交叉（${Math.round(progress)}%）...`);
    });
    
    // 分片异步分析联系方式交叉
    updateProgress(50, '正在分析联系方式交叉（0%）...');
    await analyzeContactCrossAsync(projectList, (progress) => {
      updateProgress(50 + progress * 0.4, `正在分析联系方式交叉（${Math.round(progress)}%）...`);
    });
    
    // 显示结果
    updateProgress(95, '正在整理结果...');
    await new Promise(resolve => setTimeout(resolve, 100));
    
    displayResults();
    document.getElementById('loading-section').classList.add('hidden');
    document.getElementById('results-section').classList.remove('hidden');
    updateProgress(100, '分析完成！');
    
  } catch (error) {
    handleAnalysisError(error);
  }
}
    // 异步分片处理人员/单位交叉分析
async function analyzePersonCrossAsync(projectList, onProgress) {
  return new Promise((resolve) => {
    // 预建人员/单位索引（可同步完成）
    const supplierPersons = {};
    
    // 处理法定代表人
    importedData.table2.forEach(company => {
      const name = company['原文件导入名称'];
      if (!name) return;
      if (!supplierPersons[name]) supplierPersons[name] = [];
      if (company['法定代表人']) {
        supplierPersons[name].push({
          name: company['法定代表人'],
          type: '法定代表人',
          details: ''
        });
      }
    });
    
    // 处理实控人、股东、高管（类似处理）
    importedData.table3.forEach(r => {
      const name = r['企业名称'];
      if (name && r['实控人']) {
        if (!supplierPersons[name]) supplierPersons[name] = [];
        supplierPersons[name].push({ name: r['实控人'], type: '实控人', details: `股份：${r['股份'] || '未知'}` });
      }
    });
    
    importedData.table4.forEach(r => {
      const name = r['企业名称'];
      if (name && r['股东名']) {
        if (!supplierPersons[name]) supplierPersons[name] = [];
        supplierPersons[name].push({ name: r['股东名'], type: '股东', details: `股份：${r['股份'] || '未知'}` });
      }
    });
    
    importedData.table5.forEach(r => {
      const name = r['企业名称'];
      if (name && r['高管名']) {
        if (!supplierPersons[name]) supplierPersons[name] = [];
        supplierPersons[name].push({ name: r['高管名'], type: '高管', details: `职务：${r['高管职务'] || '未知'}` });
      }
    });
    
    // 分片检查交叉
    const BATCH_SIZE = 50; // 每批处理50个供应商对
    let processedPairs = 0;
    let totalPairs = 0;
    
    // 计算总对数
    projectList.forEach(p => {
      const n = p.suppliers.length;
      totalPairs += (n * (n - 1)) / 2;
    });
    
    let currentProjectIndex = 0;
    let currentPairIndex = 0;
    
    const processBatch = () => {
      let batchCount = 0;
      
      while (currentProjectIndex < projectList.length && batchCount < BATCH_SIZE) {
        const project = projectList[currentProjectIndex];
        const suppliers = project.suppliers;
        
        // 处理当前项目的剩余供应商对
        for (let i = currentPairIndex; i < suppliers.length && batchCount < BATCH_SIZE; i++) {
          const supplierA = suppliers[i];
          const personsA = supplierPersons[supplierA] || [];
          
          for (let j = i + 1; j < suppliers.length && batchCount < BATCH_SIZE; j++) {
            const supplierB = suppliers[j];
            const personsB = supplierPersons[supplierB] || [];
            
// 查找共同人员/单位
personsA.forEach(pA => {
  // 跳过姓名为"-"的情况
  if (!pA.name || pA.name.trim() === '-') return;
  
  const match = personsB.find(pB => 
    pB.name && pB.name.trim() !== '-' &&
    pA.name.trim().toLowerCase() === pB.name.trim().toLowerCase()
  );
  if (match) {
    const clueKey = `${project.id}-${supplierA}-${supplierB}-${pA.name}`;
    if (!analysisResults.some(r => r.clueKey === clueKey)) {
      analysisResults.push({
        clueKey,
        projectId: project.id,
        type: '人员/单位',
        sameInfo: pA.name,
        description: `【${supplierA}】与【${supplierB}】存在相同的人员/单位：${pA.name}。-${pA.name}在【${supplierA}】担任：${pA.type}${pA.details ? '（' + pA.details + '）' : ''}，在【${supplierB}】担任：${match.type}${match.details ? '（' + match.details + '）' : ''}`
      });
    }
  }
});

// 【新增】检查控制关系：supplierA是否是supplierB的实控人
const controllerB = importedData.table3.find(r => 
  r['企业名称'] === supplierB && r['实控人'] === supplierA
);
if (controllerB) {
  const clueKey = `${project.id}-${supplierA}-${supplierB}-control`;
  if (!analysisResults.some(r => r.clueKey === clueKey)) {
    analysisResults.push({
      clueKey,
      projectId: project.id,
      type: '人员/单位',
      sameInfo: supplierA,
      description: `【${supplierA}】与【${supplierB}】存在控制关系。-【${supplierA}】为【${supplierB}】的实控人（股份：${controllerB['股份'] || '未知'}）`
    });
  }
}

// 【新增】检查反向控制关系：supplierB是否是supplierA的实控人
const controllerA = importedData.table3.find(r => 
  r['企业名称'] === supplierA && r['实控人'] === supplierB
);
if (controllerA) {
  const clueKey = `${project.id}-${supplierB}-${supplierA}-control`;
  if (!analysisResults.some(r => r.clueKey === clueKey)) {
    analysisResults.push({
      clueKey,
      projectId: project.id,
      type: '人员/单位',
      sameInfo: supplierB,
      description: `【${supplierB}】与【${supplierA}】存在控制关系。-【${supplierB}】为【${supplierA}】的实控人（股份：${controllerA['股份'] || '未知'}）`
    });
  }
}

// 【新增】检查持股关系：supplierA是否是supplierB的股东
const shareholderB = importedData.table4.find(r => 
  r['企业名称'] === supplierB && r['股东名'] === supplierA
);
if (shareholderB) {
  const clueKey = `${project.id}-${supplierA}-${supplierB}-shareholder`;
  if (!analysisResults.some(r => r.clueKey === clueKey)) {
    analysisResults.push({
      clueKey,
      projectId: project.id,
      type: '人员/单位',
      sameInfo: supplierA,
      description: `【${supplierA}】与【${supplierB}】存在持股关系。-【${supplierA}】为【${supplierB}】的股东（股份：${shareholderB['股份'] || '未知'}）`
    });
  }
}

// 【新增】检查反向持股关系：supplierB是否是supplierA的股东
const shareholderA = importedData.table4.find(r => 
  r['企业名称'] === supplierA && r['股东名'] === supplierB
);
if (shareholderA) {
  const clueKey = `${project.id}-${supplierB}-${supplierA}-shareholder`;
  if (!analysisResults.some(r => r.clueKey === clueKey)) {
    analysisResults.push({
      clueKey,
      projectId: project.id,
      type: '人员/单位',
      sameInfo: supplierB,
      description: `【${supplierB}】与【${supplierA}】存在持股关系。-【${supplierB}】为【${supplierA}】的股东（股份：${shareholderA['股份'] || '未知'}）`
    });
  }
}

batchCount++;
processedPairs++;
          }
          currentPairIndex = i + 1;
        }
        
        // 当前项目处理完，切换到下一个
        if (currentPairIndex >= suppliers.length - 1) {
          currentProjectIndex++;
          currentPairIndex = 0;
        }
      }
      
      // 更新进度
      const progress = totalPairs > 0 ? (processedPairs / totalPairs) * 100 : 100;
      onProgress(progress);
      
      // 继续下一批或完成
      if (currentProjectIndex < projectList.length) {
        setTimeout(processBatch, 10); // 10ms后处理下一批，让UI响应
      } else {
        resolve();
      }
    };
    
    processBatch();
  });
}
	// 异步分片处理联系方式交叉分析
async function analyzeContactCrossAsync(projectList, onProgress) {
  return new Promise((resolve) => {
    // 预建联系信息索引
    const supplierContacts = {};
    
    importedData.table2.forEach(company => {
      const name = company['原文件导入名称'];
      if (!name) return;
      if (!supplierContacts[name]) supplierContacts[name] = { phones: [], emails: [], addresses: [] };
      
      // 电话
      if (company['电话']) supplierContacts[name].phones.push(String(company['电话']).trim());
      if (company['更多电话']) {
        supplierContacts[name].phones.push(...String(company['更多电话']).split(/[\s,;]+/).filter(p => p.trim()));
      }
      
      // 邮箱
      if (company['邮箱']) supplierContacts[name].emails.push(String(company['邮箱']).trim().toLowerCase());
      if (company['更多邮箱']) {
        supplierContacts[name].emails.push(...String(company['更多邮箱']).split(/[\s,;]+/).filter(e => e.trim()).map(e => e.toLowerCase()));
      }
      
      // 地址
      if (company['企业地址']) supplierContacts[name].addresses.push(String(company['企业地址']).trim());
      if (company['通信地址']) supplierContacts[name].addresses.push(String(company['通信地址']).trim());
    });
    
    // 分片检查
    const BATCH_SIZE = 80; // 每批处理80个检查
    let processedChecks = 0;
    let totalChecks = 0;
    
    // 计算总检查次数
    projectList.forEach(p => {
      const n = p.suppliers.length;
      const pairs = (n * (n - 1)) / 2;
      totalChecks += pairs * 3; // 电话、邮箱、地址三种检查
    });
    
    let currentProjectIndex = 0;
    let currentPairIndex = 0;
    let currentCheckType = 0; // 0:电话, 1:邮箱, 2:地址
    
    const processBatch = () => {
      let batchCount = 0;
      
      while (currentProjectIndex < projectList.length && batchCount < BATCH_SIZE) {
        const project = projectList[currentProjectIndex];
        const suppliers = project.suppliers;
        
        for (let i = currentPairIndex; i < suppliers.length && batchCount < BATCH_SIZE; i++) {
          const supplierA = suppliers[i];
          const contactsA = supplierContacts[supplierA] || { phones: [], emails: [], addresses: [] };
          
          for (let j = i + 1; j < suppliers.length && batchCount < BATCH_SIZE; j++) {
            const supplierB = suppliers[j];
            const contactsB = supplierContacts[supplierB] || { phones: [], emails: [], addresses: [] };
            
            // 根据currentCheckType执行不同检查
            if (currentCheckType === 0) {
              // 电话检查
contactsA.phones.forEach(phone => {
  // 跳过电话为"-"的情况
  if (!phone || phone.trim() === '-') return;
  
  if (contactsB.phones.some(phoneB => phoneB && phoneB.trim() !== '-' && phoneB === phone)) {
    const clueKey = `${project.id}-${supplierA}-${supplierB}-phone-${phone}`;
    if (!analysisResults.some(r => r.clueKey === clueKey)) {
      analysisResults.push({
        clueKey,
        projectId: project.id,
        type: '电话',
        sameInfo: phone,
        description: `【${supplierA}】与【${supplierB}】存在相同的电话：${phone}`
      });
    }
  }
});
            } else if (currentCheckType === 1) {
              // 邮箱检查
contactsA.emails.forEach(email => {
  // 跳过邮箱为"-"的情况
  if (!email || email.trim() === '-') return;
  
  if (contactsB.emails.some(emailB => emailB && emailB.trim() !== '-' && emailB === email)) {
    const clueKey = `${project.id}-${supplierA}-${supplierB}-email-${email}`;
    if (!analysisResults.some(r => r.clueKey === clueKey)) {
      analysisResults.push({
        clueKey,
        projectId: project.id,
        type: '邮箱',
        sameInfo: email,
        description: `【${supplierA}】与【${supplierB}】存在相同的邮箱：${email}`
      });
    }
  }
});
            } else if (currentCheckType === 2) {
             // 地址检查
contactsA.addresses.forEach(addr => {
  // 跳过地址为"-"的情况
  if (!addr || addr.trim() === '-') return;
  
  if (contactsB.addresses.some(addressB => addressB && addressB.trim() !== '-' && addressB === addr)) {
    const clueKey = `${project.id}-${supplierA}-${supplierB}-address-${addr}`;
    if (!analysisResults.some(r => r.clueKey === clueKey)) {
      analysisResults.push({
        clueKey,
        projectId: project.id,
        type: '地址',
        sameInfo: addr,
        description: `【${supplierA}】与【${supplierB}】存在相同的地址：${addr}`
      });
    }
  }
});
            }
            
            batchCount++;
            processedChecks++;
          }
          currentPairIndex = i + 1;
        }
        
        if (currentPairIndex >= suppliers.length - 1) {
          currentPairIndex = 0;
          currentCheckType++;
          if (currentCheckType > 2) {
            currentCheckType = 0;
            currentProjectIndex++;
          }
        }
      }
      
      // 更新进度
      const progress = totalChecks > 0 ? (processedChecks / totalChecks) * 100 : 100;
      onProgress(progress);
      
      if (currentProjectIndex < projectList.length) {
        setTimeout(processBatch, 10);
      } else {
        resolve();
      }
    };
    
    processBatch();
  });
}
	
    // 处理分析过程中的错误
    function handleAnalysisError(error) {
      console.error('分析过程出错:', error);
      showNotification('error', '分析失败', `数据分析过程中出现错误: ${error.message}`);
      document.getElementById('loading-section').classList.add('hidden');
      document.querySelector('section').classList.remove('hidden');
    }
    
    // 分析人员交叉
    function analyzePersonCross(projectList) {
      // 验证必要数据
      if (!importedData.table2 || importedData.table2.length === 0) {
        throw new Error('供应商基本信息表数据为空');
      }
      if (!importedData.table3 || importedData.table3.length === 0) {
        throw new Error('实控人信息表数据为空');
      }
      if (!importedData.table4 || importedData.table4.length === 0) {
        throw new Error('股东信息表数据为空');
      }
      if (!importedData.table5 || importedData.table5.length === 0) {
        throw new Error('高管信息表数据为空');
      }
      
      // 为每个供应商建立人员索引
      const supplierPersons = {};
      
      // 处理法定代表人
      importedData.table2.forEach(company => {
        const supplierName = company['原文件导入名称'];
        if (!supplierName) return;
        
        if (!supplierPersons[supplierName]) {
          supplierPersons[supplierName] = [];
        }
        
        if (company['法定代表人']) {
          supplierPersons[supplierName].push({
            name: company['法定代表人'],
            type: '法定代表人',
            details: ''
          });
        }
      });
      
      // 处理实控人
      importedData.table3.forEach(record => {
        const supplierName = record['企业名称'];
        if (!supplierName) return;
        
        if (!supplierPersons[supplierName]) {
          supplierPersons[supplierName] = [];
        }
        
        if (record['实控人']) {
          supplierPersons[supplierName].push({
            name: record['实控人'],
            type: '实控人',
            details: `股份：${record['股份'] || '未知'}`
          });
        }
      });
      
      // 处理股东
      importedData.table4.forEach(record => {
        const supplierName = record['企业名称'];
        if (!supplierName) return;
        
        if (!supplierPersons[supplierName]) {
          supplierPersons[supplierName] = [];
        }
        
        if (record['股东名']) {
          supplierPersons[supplierName].push({
            name: record['股东名'],
            type: '股东',
            details: `股份：${record['股份'] || '未知'}`
          });
        }
      });
      
      // 处理高管
      importedData.table5.forEach(record => {
        const supplierName = record['企业名称'];
        if (!supplierName) return;
        
        if (!supplierPersons[supplierName]) {
          supplierPersons[supplierName] = [];
        }
        
        if (record['高管名']) {
          supplierPersons[supplierName].push({
            name: record['高管名'],
            type: '高管',
            details: `职务：${record['高管职务'] || '未知'}`
          });
        }
      });
      
      // 检查每个项目的供应商之间的人员交叉
      projectList.forEach(project => {
        const { id, name, suppliers } = project;
        const supplierList = Array.from(suppliers);
        
        // 限制单次循环的供应商数量，防止大数据量时卡住
        if (supplierList.length > 50) {
          showNotification('warning', '供应商数量过多', 
            `项目 ${name} 包含超过50个供应商，可能影响分析速度`);
        }
        
        // 检查所有供应商对
        for (let i = 0; i < supplierList.length; i++) {
          const supplierA = supplierList[i];
          const personsA = supplierPersons[supplierA] || [];
          
          // 每处理10个供应商对，短暂释放线程
          if (i % 10 === 0) {
            // 这是一个技巧，允许UI更新
            void Promise.resolve();
          }
          
          for (let j = i + 1; j < supplierList.length; j++) {
            const supplierB = supplierList[j];
            const personsB = supplierPersons[supplierB] || [];
            
            // 查找共同人员
            personsA.forEach(personA => {
              const matchingPerson = personsB.find(personB => 
                personB.name && personA.name && 
                personB.name.trim().toLowerCase() === personA.name.trim().toLowerCase()
              );
              
              if (matchingPerson) {
                // 记录线索，避免重复
                const clueKey = `${id}-${supplierA}-${supplierB}-${personA.name}`;
                if (!analysisResults.some(r => r.clueKey === clueKey)) {
                  analysisResults.push({
                    clueKey,
                    projectId: id,
                    type: '人员/单位',
                    sameInfo: personA.name,
                    description: `【${supplierA}】与【${supplierB}】存在相同的人员/单位：${personA.name}。-${personA.name}在【${supplierA}】担任：${personA.type}${personA.details ? '（' + personA.details + '）' : ''}，在【${supplierB}】担任：${matchingPerson.type}${matchingPerson.details ? '（' + matchingPerson.details + '）' : ''}`
                  });
                }
              }
            });
          }
        }
      });
    }
    
    // 分析联系方式和地址交叉
// 分析联系方式和地址交叉
function analyzeContactCross(projectList) {
  // 为每个供应商建立联系信息索引
  const supplierContacts = {};

  importedData.table2.forEach(company => {
    const supplierName = company['原文件导入名称'];
    if (!supplierName) return;

    if (!supplierContacts[supplierName]) {
      supplierContacts[supplierName] = {
        phones: [],
        emails: [],
        addresses: []
      };
    }

    // 处理电话（支持格式：0531-66563421 或 13812345678）
    const phoneStr = String(company['电话'] || '').trim();
    if (phoneStr) supplierContacts[supplierName].phones.push(phoneStr);

    if (company['更多电话']) {
      const morePhoneStr = String(company['更多电话']);
      const morePhones = morePhoneStr.split(/[\s,;]+/).filter(phone => phone.trim());
      supplierContacts[supplierName].phones.push(...morePhones);
    }

    // 处理邮箱
    const emailStr = String(company['邮箱'] || '').trim().toLowerCase();
    if (emailStr) supplierContacts[supplierName].emails.push(emailStr);

    if (company['更多邮箱']) {
      const moreEmailStr = String(company['更多邮箱']);
      const moreEmails = moreEmailStr.split(/[\s,;]+/).filter(email => email.trim());
      supplierContacts[supplierName].emails.push(...moreEmails.map(e => e.toLowerCase()));
    }

    // 处理地址
    const addressStr = String(company['企业地址'] || '').trim();
    if (addressStr) supplierContacts[supplierName].addresses.push(addressStr);

    const commAddressStr = String(company['通信地址'] || '').trim();
    if (commAddressStr) supplierContacts[supplierName].addresses.push(commAddressStr);
  });

  // 检查每个项目的供应商之间的联系信息交叉
  projectList.forEach(project => {
    const { id, name, suppliers } = project;
    const supplierList = Array.from(suppliers);

    for (let i = 0; i < supplierList.length; i++) {
      const supplierA = supplierList[i];
      const contactsA = supplierContacts[supplierA] || { phones: [], emails: [], addresses: [] };

      if (i % 10 === 0) {
        void Promise.resolve();
      }

      for (let j = i + 1; j < supplierList.length; j++) {
        const supplierB = supplierList[j];
        const contactsB = supplierContacts[supplierB] || { phones: [], emails: [], addresses: [] };

        // 检查电话交叉
        contactsA.phones.forEach(phoneA => {
          if (phoneA && contactsB.phones.some(phoneB => phoneB && phoneB === phoneA)) {
            const clueKey = `${id}-${supplierA}-${supplierB}-phone-${phoneA}`;
            if (!analysisResults.some(r => r.clueKey === clueKey)) {
              analysisResults.push({
                clueKey,
                projectId: id,
                type: '电话',
                sameInfo: phoneA,
                description: `【${supplierA}】与【${supplierB}】存在相同的电话：${phoneA}`
              });
            }
          }
        });

        // 检查邮箱交叉
        contactsA.emails.forEach(emailA => {
          if (emailA && contactsB.emails.some(emailB => emailB && emailB === emailA)) {
            const clueKey = `${id}-${supplierA}-${supplierB}-email-${emailA}`;
            if (!analysisResults.some(r => r.clueKey === clueKey)) {
              analysisResults.push({
                clueKey,
                projectId: id,
                type: '邮箱',
                sameInfo: emailA,
                description: `【${supplierA}】与【${supplierB}】存在相同的邮箱：${emailA}`
              });
            }
          }
        });

        // 检查地址交叉
        contactsA.addresses.forEach(addressA => {
          if (addressA && contactsB.addresses.some(addressB => addressB && addressB === addressA)) {
            const clueKey = `${id}-${supplierA}-${supplierB}-address-${addressA}`;
            if (!analysisResults.some(r => r.clueKey === clueKey)) {
              analysisResults.push({
                clueKey,
                projectId: id,
                type: '地址',
                sameInfo: addressA,
                description: `【${supplierA}】与【${supplierB}】存在相同的地址：${addressA}`
              });
            }
          }
        });
      }
    }
  });
}
    
     // 显示分析结果（支持分页）
function displayResults() {
  // 折叠系统介绍区域（带动画）
  const introSection = document.querySelector('.bg-white.rounded-xl.shadow-sm.p-6.mb-8');
  if (introSection && !introSection.classList.contains('folding')) {
    introSection.classList.add('folding');
    introSection.style.transition = 'max-height 0.4s ease, opacity 0.4s ease, padding 0.4s ease';
    introSection.style.overflow = 'hidden';
    introSection.style.maxHeight = introSection.scrollHeight + 'px';
    void introSection.offsetHeight;
    introSection.style.maxHeight = '0px';
    introSection.style.opacity = '0';
    introSection.style.paddingTop = '0';
    introSection.style.paddingBottom = '0';

    introSection.addEventListener('transitionend', () => {
      introSection.classList.add('hidden');
      introSection.classList.remove('folding');
      ['transition','max-height','opacity','paddingTop','paddingBottom','overflow']
        .forEach(k => introSection.style.removeProperty(k));
    }, { once: true });
  }

  // 重置分页和视图状态
  currentPage = 1;
  isSummaryView = true; // 默认显示汇总视图
  filteredResults = [...analysisResults]; // 初始化过滤结果为全部
   // ===== 预处理：为每条线索增加（供应商/客户）标志 =====
  buildSupplierTagMap();                 // ① 建“公司→标签”哈希表
  analysisResults.forEach(r => r.descWithTag = buildDescWithTag(r)); // ② 生成新描述

  // 渲染统计卡片
  renderStatCards();
  updateStatNumbers(); // 更新统计卡片中的数字
  // 显示结果
  if (analysisResults.length === 0) {
  const resultsBody = document.getElementById('results-body');
  const paginationEl = document.getElementById('pagination');
  // 明细页面增加序号列后，列数从5变为6
  resultsBody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-neutral-500">未发现任何交叉线索</td></tr>';
  paginationEl.style.display = 'none';
} else {
          // 隐藏返回按钮（默认在汇总视图）
      document.getElementById('back-to-summary-btn').classList.add('hidden');
    
    // 渲染表头
    renderTableHeader();

    // 显示分页结果
    renderResultsPage();
    
    // 显示分页控件
    document.getElementById('pagination').style.display = 'flex';
    updatePaginationInfo();
  }
}

// 建立“供应商→交易类型”映射表
function buildSupplierTagMap() {
  if (window._supplierTagMap) return;          // 只建一次
  const map = {};
  (importedData.table1 || []).forEach(row => {
    const key = `${row['采办-标段编号']}@${row['投标供应商']}`;
    map[key] = row['交易类型（采购/销售）'] === '销售' ? '客户' : '供应商';
  });
  window._supplierTagMap = map;
}

// 把原描述改造成带（供应商）/（客户）标志的新描述
function buildDescWithTag(r) {
  const map = window._supplierTagMap;
  let desc = r.description;
  // 正则匹配原描述里的“【公司名】”
  const matches = [...desc.matchAll(/【([^】]+)】/g)];
  if (matches.length >= 1) {
    const tag1 = map[`${r.projectId}@${matches[0][1]}`] || '供应商';
    desc = desc.replace(`【${matches[0][1]}】`, `（${tag1}）【${matches[0][1]}】`);
  }
  if (matches.length >= 2) {
    const tag2 = map[`${r.projectId}@${matches[1][1]}`] || '供应商';
    desc = desc.replace(`【${matches[1][1]}】`, `（${tag2}）【${matches[1][1]}】`);
  }
  return desc;
}

// 显示项目明细
function showProjectDetails(projectId) {
  // 筛选出该项目的所有线索
  const projectDetails = analysisResults.filter(r => r.projectId === projectId);
  
  // 设置当前显示的数据
  filteredResults = projectDetails;
  
  // 切换到明细视图
  isSummaryView = false;
  
  // 重置分页
  currentPage = 1;
  
  // 重新渲染表头和结果
  renderTableHeader();
  renderResultsPage();
  updatePaginationInfo();
  
  // 显示返回按钮
document.getElementById('back-to-summary-btn').classList.remove('hidden');
  
  // 更新统计卡片中的数字
  updateStatNumbers();
}

// 返回汇总视图
function backToSummary() {
  // 重置筛选
  filteredResults = [...analysisResults];
  
  // 切换到汇总视图
  isSummaryView = true;
  
  // 重置分页
  currentPage = 1;
  
  // 重新渲染表头和结果
  renderTableHeader();
  renderResultsPage();
  updatePaginationInfo();
  
  // 隐藏返回按钮
document.getElementById('back-to-summary-btn').classList.add('hidden');
  
  // 更新统计卡片中的数字
  updateStatNumbers();
}

// 渲染表头
function renderTableHeader() {
  const thead = document.querySelector('#results-table thead tr');
  if (isSummaryView) {
    // 汇总视图表头
    thead.innerHTML = `
      <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b serial-number-col">序号</th>
      <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b project-id-col">采办-标段编号</th>
      <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b clue-count-col">涉及线索个数</th>
    `;
  } else {
    // 正常视图表头（明细页面）- 在第一列增加"序号"
    thead.innerHTML = `
      <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b">序号</th>
      <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b truncated-col">采办-标段编号</th>
      <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b">类型</th>
      <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b truncated-col">相同信息</th>
      <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b description-col">情况描述</th>
	  <th class="py-3 px-4 text-left text-sm font-semibold text-neutral-700 border-b">备注</th>
    `;
  }
}


   // 渲染当前页结果
function renderResultsPage() {
  const resultsBody = document.getElementById('results-body');
  resultsBody.innerHTML = '';

  if (isSummaryView) {
    // 汇总视图：渲染项目汇总表格
    const startIndex = (currentPage - 1) * pageSize;
    
    // 需要先计算汇总数组的总长度
    const projectSummary = {};
    filteredResults.forEach(result => {
      const key = `${result.projectId}`;
      if (!projectSummary[key]) {
        projectSummary[key] = { projectId: result.projectId, clueCount: 0 };
      }
      projectSummary[key].clueCount++;
    });
    const summaryArray = Object.values(projectSummary).sort((a, b) => b.clueCount - a.clueCount);
    
    const endIndex = Math.min(startIndex + pageSize, summaryArray.length);
    renderSummaryTable(resultsBody, startIndex, endIndex);
  } else {
    // 正常视图：渲染原始分页结果
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredResults.length);
    const pageResults = filteredResults.slice(startIndex, endIndex);

    pageResults.forEach((result, index) => {
  const row = document.createElement('tr');
  row.className = 'hover:bg-neutral-50 transition-colors';

  let typeClass = '';
  switch(result.type) {
    case '人员/单位':
      typeClass = 'bg-warning/10 text-warning';
      break;
    case '电话':
    case '邮箱':
      typeClass = 'bg-danger/10 text-danger';
      break;
    case '地址':
      typeClass = 'bg-success/10 text-success';
      break;
  }

  const sameInfoValue = result.sameInfo instanceof Date && !isNaN(result.sameInfo)
    ? result.sameInfo.toISOString().slice(0,10)
    : result.sameInfo;

  // 计算序号（基于当前页的起始索引）
  const serialNumber = startIndex + index + 1;

  const displaySerialNumber = truncateText(serialNumber, 4);
  const displayProjectId = truncateText(result.projectId, 6);
  const displaySameInfo = truncateText(sameInfoValue, 6);
    const displayDescription = truncateText(result.descWithTag || result.description, 20);
// ===== 新增：判断是否需要打星 =====
const needStar = (() => {
// 利用已生成的 descWithTag 里是否同时出现“（客户）”和“（供应商）”
const txt = result.descWithTag || result.description;
return txt.includes('（客户）') && txt.includes('（供应商）') ? '☆' : '';
})();

  row.innerHTML = `
    <td class="py-3 px-4 border-b text-sm tooltip" data-tooltip="${serialNumber}">${displaySerialNumber}</td>
    <td class="py-3 px-4 border-b text-sm truncated-col tooltip" data-tooltip="${result.projectId}">${displayProjectId}</td>
    <td class="py-3 px-4 border-b text-sm"><span class="px-2 py-1 ${typeClass} rounded-full text-xs">${result.type}</span></td>
    <td class="py-3 px-4 border-b text-sm truncated-col tooltip" data-tooltip="${sameInfoValue}">${displaySameInfo}</td>
    <td class="py-3 px-4 border-b text-sm description-col tooltip" data-tooltip="${result.descWithTag || result.description}">${displayDescription}</td>
  <td class="py-3 px-4 border-b text-sm text-center" colspan="2">${needStar}</td>
</tr>`;

  resultsBody.appendChild(row);
});
  }
}

// 渲染项目汇总表格
function renderSummaryTable(container, startIndex, endIndex) {
  // 按项目汇总线索数量
  const projectSummary = {};
  
  filteredResults.forEach(result => {
    const key = `${result.projectId}`;
    if (!projectSummary[key]) {
      projectSummary[key] = { projectId: result.projectId, clueCount: 0 };
    }
    projectSummary[key].clueCount++;
  });
  
  // 转换为数组并排序（按线索数量降序）
  const summaryArray = Object.values(projectSummary).sort((a, b) => b.clueCount - a.clueCount);
  
  // 清空容器
  container.innerHTML = '';
  
  if (summaryArray.length === 0) {
    container.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-neutral-500">暂无数据</td></tr>';
    return;
  }
  
  // 获取当前页数据并渲染表格行
  const pageResults = summaryArray.slice(startIndex, endIndex);
  pageResults.forEach((item, index) => {
    const actualIndex = startIndex + index + 1;
    const row = document.createElement('tr');
    row.className = 'hover:bg-neutral-50 transition-colors';
    
    // 添加截断文本辅助函数
    const truncateForDisplay = (text, maxLength) => {
      if (!text) return '';
      const str = String(text);
      return str.length > maxLength ? str.substring(0, maxLength) + '…' : str;
    };
    
    row.innerHTML = `
      <td class="py-3 px-4 border-b text-sm serial-number-col tooltip" data-tooltip="${actualIndex}">${actualIndex}</td>
      <td class="py-3 px-4 border-b text-sm project-id-col tooltip" data-tooltip="${item.projectId}">${truncateForDisplay(item.projectId, 30)}</td>
      <td class="py-3 px-4 border-b text-sm font-semibold text-primary clue-count-col tooltip cursor-pointer hover:bg-primary/10" data-tooltip="点击查看项目明细" onclick="showProjectDetails('${item.projectId}')">${item.clueCount}</td>
    `;
    
    container.appendChild(row);
  });
}

    // 更新分页信息显示
function updatePaginationInfo() {
  const paginationEl = document.getElementById('pagination');
  
  // 显示分页控件（汇总视图和正常视图都显示）
  paginationEl.style.display = 'flex';
  
  const showingStartEl = document.getElementById('showing-start');
  const showingEndEl = document.getElementById('showing-end');
  const totalCountEl = document.getElementById('total-count');

  let total, startIndex, endIndex;
  
  if (isSummaryView) {
    // 汇总视图：计算项目总数
    const projectSummary = {};
    filteredResults.forEach(result => {
      const key = `${result.projectId}`;
      if (!projectSummary[key]) {
        projectSummary[key] = { projectId: result.projectId,  clueCount: 0 };
      }
      projectSummary[key].clueCount++;
    });
    const summaryArray = Object.values(projectSummary).sort((a, b) => b.clueCount - a.clueCount);
    
    total = summaryArray.length;
    startIndex = (currentPage - 1) * pageSize + 1;
    endIndex = Math.min(currentPage * pageSize, total);
  } else {
    // 正常视图
    total = filteredResults.length;
    startIndex = (currentPage - 1) * pageSize + 1;
    endIndex = Math.min(currentPage * pageSize, total);
  }

  showingStartEl.textContent = total > 0 ? startIndex : 0;
  showingEndEl.textContent = endIndex;
  totalCountEl.textContent = total;

  // 更新分页按钮状态
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');

  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= Math.ceil(total / pageSize);
}

    // 翻页功能
    function changePage(direction) {
      const totalPages = Math.ceil(filteredResults.length / pageSize);
      
      if (direction === 'prev' && currentPage > 1) {
        currentPage--;
        renderResultsPage();
        updatePaginationInfo();
      } else if (direction === 'next' && currentPage < totalPages) {
        currentPage++;
        renderResultsPage();
        updatePaginationInfo();
      }
      
    }

    // 处理每页条数变化
    function handlePageSizeChange() {
      const select = document.getElementById('page-size');
      pageSize = parseInt(select.value);
      currentPage = 1; // 重置到第一页
      renderResultsPage();
      updatePaginationInfo();
    }

// 渲染统计卡片（在displayResults中调用）
function renderStatCards() {
  const totalProjectsEl = document.getElementById('total-projects');
  
  // 计算统计数据
  const uniqueProjects = new Set(analysisResults.map(r => `${r.projectId}`));
  
  // 更新数字显示
  totalProjectsEl.textContent = uniqueProjects.size;
}
 
 /**
 * 更新统计卡片中的数字
 * 根据当前视图状态（汇总/明细）更新线索个数和涉及项目个数
 */
function updateStatNumbers() {
  const totalCluesEl = document.getElementById('total-clues');
  const totalProjectsEl = document.getElementById('total-projects');
  
  if (!totalCluesEl || !totalProjectsEl) return;
  
  // 更新线索个数（当前视图的线索数）
  totalCluesEl.textContent = filteredResults.length;
  
  // 更新涉及项目个数
  if (isSummaryView) {
    // 汇总视图：计算所有项目的唯一数量
    const uniqueProjects = new Set(filteredResults.map(r => `${r.projectId}`));
    totalProjectsEl.textContent = uniqueProjects.size;
  } else {
    // 明细视图：只涉及当前这一个项目
    totalProjectsEl.textContent = 1;
  }
}
	
    // 导出结果
function exportResults() {
  if (analysisResults.length === 0) {
    showNotification('warning', '无结果可导出', '没有分析结果可供导出');
    return;
  }
  
  // 1. 准备明细数据表（保持原有数据结构，增加序号）
  const detailData = analysisResults.map((result, index) => ({
    '序号': index + 1,
    '采办-标段编号': result.projectId,
    '类型': result.type,
    '相同信息': (result.sameInfo instanceof Date && !isNaN(result.sameInfo)
        ? result.sameInfo.toISOString().slice(0,10)
        : result.sameInfo),
    '情况描述': result.descWithTag || result.description,
	'备注': (result.descWithTag || result.description).includes('（客户）') &&
(result.descWithTag || result.description).includes('（供应商）') ? '☆' : ''
  }));
  
  // 2. 准备汇总情况表（按项目统计线索数量，增加序号）
  const projectSummary = {};
  analysisResults.forEach(result => {
    const key = `${result.projectId}`;
    if (!projectSummary[key]) {
      projectSummary[key] = {
        '采办-标段编号': result.projectId,
        '涉及线索个数': 0
      };
    }
    projectSummary[key]['涉及线索个数']++;
  });
  
  // 转换为数组并按线索数量降序排序，增加序号
  const summaryData = Object.values(projectSummary)
    .sort((a, b) => b['涉及线索个数'] - a['涉及线索个数'])
    .map((item, index) => ({
      '序号': index + 1,
      '采办-标段编号': item['采办-标段编号'],
      '涉及线索个数': item['涉及线索个数']
    }));
  
  // 3. 创建工作簿并添加两个工作表
  const workbook = XLSX.utils.book_new();
  
  // 添加汇总情况表（第一个sheet）
  const summaryWorksheet = XLSX.utils.json_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(workbook, summaryWorksheet, '汇总情况表');
  
  // 添加明细数据表（第二个sheet）
  const detailWorksheet = XLSX.utils.json_to_sheet(detailData);
  XLSX.utils.book_append_sheet(workbook, detailWorksheet, '明细数据表');
  
  // 生成文件名（包含当前日期）
  const today = new Date();
  const dateStr = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`;
  const fileName = `采办项目疑似串通投标分析结果_${dateStr}.xlsx`;
  
  // 导出文件
  XLSX.writeFile(workbook, fileName);
  showNotification('success', '导出成功', `分析结果已导出为：${fileName}（包含汇总情况表和明细数据表）`);
}
    
    // 通知提示功能
    function showNotification(type, title, message) {
      const notification = document.getElementById('notification');
      const icon = document.getElementById('notification-icon');
      const titleEl = document.getElementById('notification-title');
      const messageEl = document.getElementById('notification-message');
      
      // 设置通知类型
      icon.className = '';
      if (type === 'success') {
        icon.className = 'fa fa-check-circle text-success text-xl mt-0.5 mr-3';
      } else if (type === 'error') {
        icon.className = 'fa fa-exclamation-circle text-danger text-xl mt-0.5 mr-3';
      } else if (type === 'info') {
        icon.className = 'fa fa-info-circle text-primary text-xl mt-0.5 mr-3';
      } else if (type === 'warning') {
        icon.className = 'fa fa-exclamation-triangle text-warning text-xl mt-0.5 mr-3';
      }
      
      // 设置内容
      titleEl.textContent = title;
      messageEl.textContent = message;
      
      // 显示通知
      notification.classList.remove('hidden', 'translate-y-20', 'opacity-0');
      notification.classList.add('translate-y-0', 'opacity-100');
      
      // 自动关闭
      setTimeout(hideNotification, 5000);
    }
    
    function hideNotification() {
      const notification = document.getElementById('notification');
      notification.classList.remove('translate-y-0', 'opacity-100');
      notification.classList.add('translate-y-20', 'opacity-0');
      
      setTimeout(() => {
        notification.classList.add('hidden');
      }, 300);
    }
	/* ===== 折叠系统介绍 ===== */
function collapseIntro() {
  const intro = document.querySelector('.bg-white.rounded-xl.shadow-sm.p-6.mb-8'); // 方案 A
  // const intro = document.getElementById('intro-panel');                       // 方案 B
  if (!intro || intro.classList.contains('folding')) return;   // 防止重复触发

  intro.classList.add('folding');          // 标记正在折叠
  intro.style.transition = 'max-height 0.4s ease, opacity 0.4s ease, padding 0.4s ease';
  intro.style.overflow = 'hidden';
  // 让浏览器先计算出实际高度
  intro.style.maxHeight = intro.scrollHeight + 'px';
  intro.offsetHeight;                      // 强制 reflow
  // 开始折叠
  intro.style.maxHeight = '0px';
  intro.style.opacity   = '0';
  intro.style.paddingTop = '0';
  intro.style.paddingBottom = '0';

  intro.addEventListener('transitionend', () => {
    intro.classList.add('hidden');
    intro.classList.remove('folding');
    // 清理内联样式，避免以后展开异常
    ['transition','max-height','opacity','paddingTop','paddingBottom','overflow']
      .forEach(k => intro.style.removeProperty(k));
  }, { once: true });
}
/* ===== 重新导入数据按钮事件 ===== */
document.getElementById('reimport-btn').addEventListener('click', function () {
  // 1. 清空已导入数据
  for (let key in importedData) importedData[key] = null;

  // 2. 清空分析结果
  analysisResults = [];

  // 3. 隐藏结果区域
  document.getElementById('results-section').classList.add('hidden');

  // 4. 显示导入区域
  document.querySelector('section').classList.remove('hidden');

  // 5. 禁用分析按钮
  document.getElementById('analyze-btn').setAttribute('disabled', 'true');

  // 6. 重置所有文件预览区
  document.querySelectorAll('.file-preview').forEach(preview => {
    preview.classList.add('hidden');
    const dropArea = preview.previousElementSibling;
    dropArea.classList.remove('hidden');
    const input = dropArea.querySelector('input[type="file"]');
    if (input) input.value = '';
  });

  // 7. 默认展开第一个表格
  const firstHeader = document.querySelector('.import-header');
  const firstContent = document.getElementById('table1-content');
  const firstIcon   = firstHeader.querySelector('i');
  firstContent.classList.remove('hidden');
  firstIcon.classList.add('rotate-180');

    // 8. 显示"一键导入示例数据"按钮
  const sampleBtn = document.getElementById('import-sample-btn');
  if (sampleBtn) {
    sampleBtn.classList.remove('hidden');
    sampleBtn.innerHTML = '<i class="fa fa-magic mr-2"></i>一键导入示例数据';
    sampleBtn.disabled = false;
    sampleBtn.classList.remove('opacity-75', 'cursor-not-allowed');
  }

  // 9. 提示用户
  showNotification('info', '已重置', '请重新导入所有数据表格');
});

// ===== 更新日志功能实现（新增代码） =====
// 更新日志数据（按日期倒序排列，最新的在最前）
const changelogData = [
 {
    date: '2025年12月25日丨',
    content: '1、优化线索分类；\n2、增加对供应商之间的直接控制和控股关系分析。'
  },
 {
    date: '2025年12月1日丨',
    content: '1、增加一键导入示例数据功能；\n2、优化界面显示效果。'
  },
  {
    date: '2025年11月20日丨',
    content: '1、新增分析结果汇总分析页面；\n2、新增导出汇总分析页面数据；\n3、优化分析逻辑；\n4、增加网页密码锁功能。'
  },
  {
    date: '2025年11月19日丨',
    content: '1、新增结果分页显示；\n2、调整分析结果概览显示区域；\n3、新增更新日志；\n4、固定分析结果列宽度；\n5、新增悬浮显示完整信息。'
  },
  {
    date: '2025年11月13日丨',
    content: '1、优化分析算法，提升大数据量处理性能；\n2、新增导入数据清理功能，自动去除重复数据和无效数据；\n3、新增分析进度条显示。'
  },
  {
    date: '2025年11月12日丨',
    content: '1、新增数据导入模板下载功能；\n2、优化导入数据预览表格显示效果；\n3、优化界面显示效果。'
  },
  {
    date: '2025年11月10日丨',
    content: '1、新增数据来源网站链接；\n2、新增导入数据模板下载；\n3、优化界面显示效果。'
  },
  {
    date: '2025年11月7日丨',
    content: '1、建立分析主逻辑；\n2、支持分析结果导出；\n3、优化界面显示效果。'
  }
];

// 更新日志相关变量
let currentChangelogPage = 0;

// 初始化更新日志功能
function initChangelog() {
  const changelogBtn = document.getElementById('changelog-btn');
  const modal = document.getElementById('changelog-modal');
  const closeBtn = document.getElementById('changelog-close');
  const prevBtn = document.getElementById('prev-page-btn');
  const nextBtn = document.getElementById('next-page-btn');

  // 打开模态框
  changelogBtn.addEventListener('click', () => {
    currentChangelogPage = 0; // 默认显示最新一页
    showChangelogModal();
  });

  // 关闭模态框（点击关闭按钮）
  closeBtn.addEventListener('click', hideChangelogModal);

  // 关闭模态框（点击背景）
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      hideChangelogModal();
    }
  });

  // 翻页功能
  prevBtn.addEventListener('click', () => {
    if (currentChangelogPage < changelogData.length - 1) {
      currentChangelogPage++;
      updateChangelogContent();
    }
  });

  nextBtn.addEventListener('click', () => {
    if (currentChangelogPage > 0) {
      currentChangelogPage--;
      updateChangelogContent();
    }
  });

  // 键盘支持
  document.addEventListener('keydown', (e) => {
    if (modal.classList.contains('hidden')) return;
    
    if (e.key === 'Escape') {
      hideChangelogModal();
    } else if (e.key === 'ArrowLeft') {
      if (currentChangelogPage > 0) {
        currentChangelogPage--;
        updateChangelogContent();
      }
    } else if (e.key === 'ArrowRight') {
      if (currentChangelogPage < changelogData.length - 1) {
        currentChangelogPage++;
        updateChangelogContent();
      }
    }
  });
}

// 显示更新日志模态框
function showChangelogModal() {
  const modal = document.getElementById('changelog-modal');
  modal.classList.remove('hidden');
  updateChangelogContent();
  
  // 禁用网页滚动
  document.body.style.overflow = 'hidden';
  
  // 添加淡入动画
  setTimeout(() => {
    modal.style.opacity = '1';
  }, 10);
}

// 隐藏更新日志模态框
function hideChangelogModal() {
  const modal = document.getElementById('changelog-modal');
  modal.classList.add('hidden');
  modal.style.opacity = '0';
  
  // 恢复网页滚动（解锁后始终允许滚动）
  document.body.style.overflow = 'auto';
}

// 更新公告牌内容
function updateChangelogContent() {
  const contentEl = document.getElementById('changelog-content');
  const currentPageEl = document.getElementById('current-page');
  const totalPagesEl = document.getElementById('total-pages');
  const prevBtn = document.getElementById('prev-page-btn');
  const nextBtn = document.getElementById('next-page-btn');

  const currentLog = changelogData[currentChangelogPage];
  
  // 格式化内容
  const formattedContent = currentLog.content
    .split('\n')
    .filter(line => line.trim())
    .map(line => `<div class="log-entry">${line.trim()}</div>`)
    .join('');

  // 更新内容
  contentEl.innerHTML = `<div class="log-date font-semibold mb-3 text-center">${currentLog.date}更新日志</div>${formattedContent}`;

  // 更新分页指示器
  currentPageEl.textContent = changelogData.length - currentChangelogPage;
  totalPagesEl.textContent = changelogData.length;

  // 更新翻页按钮状态
  prevBtn.disabled = currentChangelogPage >= changelogData.length - 1;
  nextBtn.disabled = currentChangelogPage <= 0;

  // 根据内容高度自动调整公告牌高度
  adjustChangelogBoardHeight();
}

// 根据内容自动调整公告牌高度
function adjustChangelogBoardHeight() {
  const board = document.getElementById('changelog-board');
  const content = document.getElementById('changelog-content');
  
  // 移除所有高度限制，让内容完整展示
  board.style.height = 'auto';
  board.style.minHeight = 'auto';
  board.style.maxHeight = 'none';
  
  // 确保内容区域也自然展开
  content.style.height = 'auto';
  
  // 根据视口高度和内容高度计算，确保不超出屏幕
  const viewportHeight = window.innerHeight;
  const contentHeight = content.scrollHeight;
  
  // 如果内容高度超过视口高度的80%，则适当限制
  if (contentHeight > viewportHeight * 0.8) {
    board.style.maxHeight = '80vh';
    board.style.overflowY = 'visible'; // 依然使用可见而非滚动
  }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
  // ... 原有初始化代码已在上面部分 ...
  
// 一键导入示例数据按钮事件
document.getElementById('import-sample-btn').addEventListener('click', importSampleData);
  
  // 初始化更新日志功能
  initChangelog();
  
  // 页面加载完成后初始化卡片功能
renderStatCards();
  
});

// ===== 示例数据功能实现（新增代码） =====

// 示例数据定义（确保产生所有类型的交叉线索）
const sampleData = {
  table1: [
    { '采办-标段编号': 'P001',  '交易类型（采购/销售）': '采购', '投标供应商': '北京华夏科技有限公司' },
    { '采办-标段编号': 'P001',  '交易类型（采购/销售）': '采购',   '投标供应商': '上海东方贸易发展有限公司' },
    { '采办-标段编号': 'P001',  '交易类型（采购/销售）': '销售',   '投标供应商': '深圳创新实业有限公司' },
    { '采办-标段编号': 'P002',  '交易类型（采购/销售）': '采购',   '投标供应商': '北京华夏科技有限公司' },
    { '采办-标段编号': 'P002',  '交易类型（采购/销售）': '销售',  '投标供应商': '广州南方信息技术有限公司' }
  ],
  table2: [
    // 北京华夏科技有限公司 - 与其它公司有多个相同信息
    {
      '原文件导入名称': '北京华夏科技有限公司', '系统匹配企业名称': '北京华夏科技有限公司', '登记状态': '存续',
      '统一社会信用代码': '91110108MA00123X0Y', '法定代表人': '王建国', // 与深圳创新实业相同
      '电话': '13800138000', '更多电话': '010-88886666', '邮箱': 'contact@common-mail.com', '更多邮箱': 'beijing@company.com',
      '企业地址': '北京市朝阳区建国路88号SOHO现代城A座1501', '通信地址': '北京市朝阳区建国路88号SOHO现代城A座1501'
    },
    // 上海东方贸易发展有限公司 - 与北京华夏有相同联系方式
    {
      '原文件导入名称': '上海东方贸易发展有限公司', '系统匹配企业名称': '上海东方贸易发展有限公司', '登记状态': '存续',
      '统一社会信用代码': '91310115MA00234Y1Z', '法定代表人': '李光华',
      '电话': '13800138000', '更多电话': '021-65555555', '邮箱': 'contact@common-mail.com', // 相同邮箱
      '企业地址': '上海市浦东新区世纪大道100号环球金融中心2002', '通信地址': '上海市浦东新区世纪大道100号环球金融中心2002'
    },
    // 深圳创新实业有限公司 - 与北京华夏有相同法人
    {
      '原文件导入名称': '深圳创新实业有限公司', '系统匹配企业名称': '深圳创新实业有限公司', '登记状态': '存续',
      '统一社会信用代码': '91440300MA00345Z2A', '法定代表人': '王建国', // 相同法人
      '电话': '13900139000', '更多电话': '0755-33334444', '邮箱': 'sz@company.com', '更多邮箱': 'info@sz-company.com',
      '企业地址': '深圳市南山区科技园南区R3栋5楼', '通信地址': '深圳市南山区科技园南区R3栋5楼'
    },
    // 广州南方信息技术有限公司 - 与北京华夏有相同电话
    {
      '原文件导入名称': '广州南方信息技术有限公司', '系统匹配企业名称': '广州南方信息技术有限公司', '登记状态': '存续',
      '统一社会信用代码': '91440101MA00456A3B', '法定代表人': '陈志强',
      '电话': '13800138000', '更多电话': '020-88887777', // 相同电话
      '邮箱': 'guangzhou@company.com', '更多邮箱': 'sales@gz-company.com',
      '企业地址': '广州市天河区珠江新城华夏路10号富力中心1803', '通信地址': '广州市天河区珠江新城华夏路10号富力中心1803'
    }
  ],
  table3: [
    { '企业名称': '北京华夏科技有限公司', '实控人': '赵文博', '股份': '65%', '开始时间': '2020-01-15', '结束时间': '-' },
    { '企业名称': '上海东方贸易发展有限公司', '实控人': '赵文博', '股份': '58%', '开始时间': '2019-08-20', '结束时间': '-' }, // 相同实控人
    { '企业名称': '深圳创新实业有限公司', '实控人': '钱海洋', '股份': '72%', '开始时间': '2021-03-10', '结束时间': '-' },
    { '企业名称': '广州南方信息技术有限公司', '实控人': '孙山峰', '股份': '48%', '开始时间': '2018-11-25', '结束时间': '-' }
  ],
  table4: [
    { '企业名称': '北京华夏科技有限公司', '股东名': '周贸易', '股份': '25%', '开始时间': '2020-01-15', '结束时间': '-' },
    { '企业名称': '上海东方贸易发展有限公司', '股东名': '周贸易', '股份': '22%', '开始时间': '2019-08-20', '结束时间': '-' }, // 相同股东
    { '企业名称': '深圳创新实业有限公司', '股东名': '吴科技', '股份': '18%', '开始时间': '2021-03-10', '结束时间': '-' },
    { '企业名称': '广州南方信息技术有限公司', '股东名': '郑信息', '股份': '30%', '开始时间': '2018-11-25', '结束时间': '-' }
  ],
  table5: [
    { '企业名称': '北京华夏科技有限公司', '高管名': '刘管理', '高管职务': '总经理', '开始时间': '2020-01-15', '结束时间': '-' },
    { '企业名称': '上海东方贸易发展有限公司', '高管名': '刘管理', '高管职务': '副总经理', '开始时间': '2019-08-20', '结束时间': '-' }, // 相同高管
    { '企业名称': '深圳创新实业有限公司', '高管名': '陈技术', '高管职务': '技术总监', '开始时间': '2021-03-10', '结束时间': '-' },
    { '企业名称': '广州南方信息技术有限公司', '高管名': '林财务', '高管职务': '财务总监', '开始时间': '2018-11-25', '结束时间': '-' }
  ]
};

// 导入示例数据主函数
async function importSampleData() {
  const btn = document.getElementById('import-sample-btn');
  if (!btn) return;
  
  // 按钮变为加载状态
  btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>正在导入示例数据...';
  btn.disabled = true;
  btn.classList.add('opacity-75', 'cursor-not-allowed');
  
  try {
    showNotification('info', '开始导入示例数据', '正在准备示例数据，请稍候...');
    
    // 模拟真实导入流程，逐表处理
    for(let i = 1; i <= 5; i++) {
      showNotification('info', `正在导入表${i}...`, `正在导入第${i}张表的示例数据...`);
      await new Promise(resolve => setTimeout(resolve, 400)); // 模拟网络延迟
      
      // 数据赋值（深度拷贝避免引用问题）
      importedData[`table${i}`] = JSON.parse(JSON.stringify(sampleData[`table${i}`]));
      
      // 更新对应表格的UI状态
      updateTableUIAfterSampleImport(i);
      
      await new Promise(resolve => setTimeout(resolve, 200));
    }
    
    // 验证所有表格都已成功导入
    const allImported = Object.values(importedData).every(data => data !== null && data.length > 0);
    
    if (allImported) {
      showNotification('success', '示例数据导入成功', '所有示例数据已导入完成，请点击"开始分析"查看结果！');
      
      // 隐藏按钮
      btn.classList.add('hidden');
      
      // 启用分析按钮
      document.getElementById('analyze-btn').removeAttribute('disabled');
      
      // 自动滚动到分析按钮位置，引导用户操作
      document.getElementById('analyze-btn').scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
      throw new Error('部分表格导入失败');
    }
    
  } catch (error) {
    console.error('导入示例数据失败:', error);
    showNotification('error', '导入失败', `示例数据导入失败：${error.message}`);
    
    // 恢复按钮状态
btn.disabled = false;
btn.innerHTML = '<i class="fa fa-magic mr-2"></i>一键导入示例数据';
btn.classList.remove('opacity-75', 'cursor-not-allowed');
    
    // 清空已导入的数据
    for(let key in importedData) importedData[key] = null;
  }
}

// 更新表格UI（示例数据导入后）
function updateTableUIAfterSampleImport(tableNum) {
  const tableKey = `table${tableNum}`;
  const dropArea = document.querySelector(`.file-drop-area[data-table="${tableNum}"]`);
  const preview = dropArea?.nextElementSibling;
  
  if (!dropArea || !preview) {
    console.error(`无法找到表格${tableNum}的UI元素`);
    return;
  }
  
  const fileNameElement = preview.querySelector('.filename');
  const totalRecordsElement = preview.querySelector('.total-records');
  const previewContainer = preview.querySelector('.data-preview-container');
  
  // 设置显示文件名
  const fileNames = {
    1: '采办项目投标供应商清单_示例数据.xlsx',
    2: '供应商基本信息表_示例数据.xlsx',
    3: '实控人信息表_示例数据.xlsx',
    4: '股东信息表_示例数据.xlsx',
    5: '高管信息表_示例数据.xlsx'
  };
  fileNameElement.textContent = fileNames[tableNum];
  
  // 更新记录数
  const data = importedData[tableKey];
  totalRecordsElement.textContent = `共 ${data.length} 条记录（示例数据）`;
  
  // 生成预览表格
  generateSampleDataPreview(data, previewContainer, tableNum);
  
  // 显示预览区域
  preview.classList.remove('hidden');
  dropArea.classList.add('hidden');
}

// 生成示例数据预览表格（简化版）
function generateSampleDataPreview(jsonData, container, tableNum) {
  if (!jsonData || jsonData.length === 0) {
    container.innerHTML = '<div class="p-4 text-center text-neutral-500">无数据可预览</div>';
    return;
  }
  
  const headers = Object.keys(jsonData[0]);
  const maxColumns = 6;
  const displayHeaders = headers.slice(0, maxColumns);
  if (headers.length > maxColumns) {
    displayHeaders.push(`...(${headers.length - maxColumns}列)`);
  }
  
  const previewRows = jsonData.slice(0, 5);
  
  let tableHtml = '<table class="min-w-full divide-y divide-neutral-200 text-xs">';
  tableHtml += '<thead><tr class="bg-neutral-50">';
  displayHeaders.forEach(header => {
    tableHtml += `<th class="px-3 py-2 text-left font-medium text-neutral-700 whitespace-nowrap">${header || '未命名列'}</th>`;
  });
  tableHtml += '</tr></thead><tbody class="bg-white divide-y divide-neutral-200">';
  
  previewRows.forEach(row => {
    tableHtml += '<tr class="hover:bg-neutral-50">';
    const values = Object.values(row);
    for (let i = 0; i < maxColumns; i++) {
      const cellValue = values[i] !== undefined ? values[i] : '';
      const displayValue = String(cellValue).length > 50 ? String(cellValue).slice(0,50)+'…' : String(cellValue);
      tableHtml += `<td class="px-3 py-1 text-neutral-800 whitespace-nowrap">${displayValue}</td>`;
    }
    if (values.length > maxColumns) {
      tableHtml += `<td class="px-3 py-2 text-neutral-500">...</td>`;
    }
    tableHtml += '</tr>';
  });
  
  tableHtml += '</tbody></table>';
  container.innerHTML = tableHtml;
}




</script>
<!-- 回到首页：平滑滚动 + 清空数据 + 重置界面 -->
<script>
document.getElementById('btn-home').addEventListener('click', () => {
  // 1. 淡出
  document.body.style.transition = 'opacity 0.35s ease';
  document.body.style.opacity = 0;

  document.body.addEventListener('transitionend', () => {
    // 2. 瞬间回到顶部
    window.scrollTo({ top: 0, behavior: 'instant' });

    // 3. 清空数据 & 界面
    resetToHomePage();          // 新增：内部完成数据清空

    // 4. 淡入
    document.body.style.opacity = 1;
  }, { once: true });
});

/* 一次性完成“回到首页 + 数据清空 + UI 重置” */
function resetToHomePage() {
  /* ---------- 1. 清空内存数据 ---------- */
  Object.keys(importedData).forEach(k => importedData[k] = null);
  analysisResults.length = 0;

  /* ---------- 2. 隐藏结果区域 ---------- */
  document.getElementById('results-section').classList.add('hidden');
  document.getElementById('loading-section').classList.add('hidden');

  /* ---------- 3. 显示导入区域 ---------- */
  document.querySelector('section').classList.remove('hidden');

  /* ---------- 4. 重置所有文件预览区 ---------- */
  document.querySelectorAll('.file-preview').forEach(preview => {
    preview.classList.add('hidden');
    const dropArea = preview.previousElementSibling;
    dropArea.classList.remove('hidden');
    const input = dropArea.querySelector('input[type="file"]');
    if (input) input.value = '';          // 清空 file input
  });

  /* ---------- 5. 禁用分析按钮 ---------- */
  document.getElementById('analyze-btn').setAttribute('disabled', 'true');

  /* ---------- 6. 只展开第一个表格 ---------- */
  // 先全部折叠
  document.querySelectorAll('.import-header').forEach(h => {
    const tgt = document.getElementById(h.dataset.target);
    const ic = h.querySelector('i');
    tgt.classList.add('hidden');
    ic.classList.remove('rotate-180');
  });
  // 再展开第一个
  const firstHeader = document.querySelector('.import-header');
  const firstContent = document.getElementById('table1-content');
  const firstIcon   = firstHeader.querySelector('i');
  firstContent.classList.remove('hidden');
  firstIcon.classList.add('rotate-180');

    /* ---------- 7. 显示"一键导入示例数据"按钮 ---------- */
  const sampleBtn = document.getElementById('import-sample-btn');
  if (sampleBtn) {
    sampleBtn.classList.remove('hidden');
    sampleBtn.innerHTML = '<i class="fa fa-magic mr-2"></i>一键导入示例数据';
    sampleBtn.disabled = false;
    sampleBtn.classList.remove('opacity-75', 'cursor-not-allowed');
  }

  /* ---------- 8. 提示用户 ---------- */
  showNotification('info', '已回到首页', '此前导入的数据已清空，请重新上传');
}
</script>
</body>
</html>